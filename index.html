<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª - ÙƒØ´Ù Ø§Ù„ØªÙƒØ±Ø§Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            font-family: 'Cairo', sans-serif; 
            box-sizing: border-box;
        }
        
        body { 
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ */
        .order-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-right: 6px solid #3b82f6;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .order-card.duplicate {
            border-right: 6px solid #ef4444;
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
            animation: pulseWarning 2s infinite;
        }
        
        .order-card.completed {
            border-right: 6px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #fff 100%);
            opacity: 0.9;
        }
        
        .order-card.pending {
            border-right: 6px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);
        }
        
        @keyframes pulseWarning {
            0%, 100% { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1); }
            50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2); }
        }
        
        /* Ø´Ø§Ø±Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± */
        .duplicate-badge {
            position: absolute;
            top: -8px;
            left: 15px;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .alert-modal {
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            animation: alertSlideIn 0.4s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            border-top: 8px solid #ef4444;
        }
        
        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        input, select, textarea {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯ */
        .reply-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            color: #1e40af;
            font-weight: 700;
            background: #f8fafc;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        /* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ */
        .admin-notes-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            color: #7c3aed;
            font-weight: 700;
            background: #f5f3ff;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #ddd6fe;
        }
        
        /* Ø§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }
        
        /* Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notifications-btn {
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙˆØ± */
        .image-preview-container {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        
        .image-preview-container:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: block;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .remove-image-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #f1f5f9;
            color: #475569;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .remove-image-btn:hover {
            background: #e2e8f0;
        }
        
        .image-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .order-image {
            width: 100%;
            max-width: 300px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 15px 0;
        }
        
        .order-image:hover {
            transform: scale(1.02);
        }
        
        /* Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }
        
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .close-image-modal {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .close-image-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
        @media (max-width: 640px) {
            .modal-content {
                padding: 20px;
                border-radius: 20px;
            }
            
            .alert-modal {
                padding: 20px;
                border-radius: 20px;
            }
            
            .image-modal-content {
                max-width: 95%;
                max-height: 80%;
            }
            
            .close-image-modal {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨ÙˆØ´ */
        .push-notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .notification-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .notification-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .notification-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡Ø§ØªÙ */
        .section-divider {
            margin: 20px 0;
            padding: 10px 0;
            position: relative;
        }
        
        .section-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, #e2e8f0, transparent);
        }
        
        .section-title {
            background: white;
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
            position: relative;
            z-index: 1;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .pending-section {
            color: #f59e0b;
            border-color: #f59e0b;
        }
        
        .completed-section {
            color: #10b981;
            border-color: #10b981;
        }
        
        .order-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .order-info-row .label {
            color: #64748b;
            font-size: 13px;
        }
        
        .order-info-row .value {
            color: #1e293b;
            font-weight: 600;
            font-size: 13px;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ */
        .order-card {
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø© */
        .filter-loading {
            display: none;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #64748b;
        }
        
        .filter-loading.active {
            display: block;
        }
        
        .spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ */
        @media (max-width: 768px) {
            .order-card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .section-divider {
                margin: 16px 0;
            }
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ */
        .order-status-timeline {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.pending {
            background: #f59e0b;
        }

        .status-dot.viewed {
            background: #3b82f6;
        }

        .status-dot.completed {
            background: #10b981;
        }

        .status-time {
            color: #64748b;
            font-size: 11px;
        }

        .status-label {
            font-weight: 600;
        }

        .status-separator {
            flex: 1;
            height: 1px;
            background: #e2e8f0;
        }
        
        /* ØªØµØ§Ù…ÙŠÙ… Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ */
        .admin-dashboard-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .user-selection-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .user-selection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        
        .user-selection-card.active {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .user-stats {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .user-stat {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: #f1f5f9;
        }
        
        .user-stat.pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .user-stat.completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .user-stat.duplicate {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* ØªØµØ§Ù…ÙŠÙ… Ø®Ø§ØµØ© Ø¨Ø®ÙŠØ§Ø± Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… */
        .focus-user-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .focus-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
        .tabs {
            display: flex;
            gap: 5px;
            background: #f1f5f9;
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: #3b82f6;
        }
        
        /* Ù…Ø¤Ø´Ø± Ø¶ØºØ· Ø§Ù„ØµÙˆØ± */
        .compression-status {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .compression-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-3xl p-10 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full mb-6 shadow-lg">
                    <i class="fas fa-shield-check text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-black text-gray-800 mb-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
                <p class="text-gray-600 text-sm">Ù…Ø¹ Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key ml-1"></i> Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="login-pass" 
                            class="w-full p-4 pr-12 border-2 border-gray-200 rounded-2xl text-center text-xl tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                            placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„"
                            maxlength="4"
                        >
                        <i class="fas fa-key absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <button 
                    onclick="handleLogin()" 
                    class="w-full btn btn-primary py-4 rounded-2xl text-lg"
                >
                    <i class="fas fa-sign-in-alt ml-2"></i> Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
                </button>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-app" class="hidden min-h-screen">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <header class="glass-card shadow-sm mb-6 mx-4 mt-4 rounded-2xl sticky top-4 z-40">
            <div class="flex justify-between items-center p-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-search-plus text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 id="user-display-name" class="font-bold text-lg text-gray-800"></h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="user-role-badge" class="badge"></span>
                            <button onclick="refreshOrders()" class="text-xs text-gray-500 hover:text-blue-600">
                                <i class="fas fa-sync-alt ml-1"></i> ØªØ­Ø¯ÙŠØ«
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                    <button 
                        onclick="toggleNotifications()" 
                        class="notifications-btn relative p-3 text-gray-600 hover:text-blue-600 transition-colors"
                    >
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                    </button>
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                    <div id="notifications-dropdown" class="hidden absolute top-20 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 max-h-96 overflow-y-auto">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                                <button onclick="markAllNotificationsAsRead()" class="text-sm text-blue-600 hover:text-blue-800">
                                    ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
                                </button>
                            </div>
                        </div>
                        <div id="notifications-list" class="p-2">
                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </div>
                    </div>
                    
                    <button 
                        onclick="logout()" 
                        class="btn btn-danger px-6"
                    >
                        <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </header>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
        <main class="max-w-6xl mx-auto px-4 pb-24">
            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
            <div id="admin-stats" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                                <h3 id="stat-total" class="text-3xl font-bold text-gray-800">0</h3>
                            </div>
                            <i class="fas fa-file-alt text-blue-500 text-2xl"></i>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                                <h3 id="stat-pending" class="text-3xl font-bold text-amber-600">0</h3>
                            </div>
                            <i class="fas fa-clock text-amber-500 text-2xl"></i>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p>
                                <h3 id="stat-done" class="text-3xl font-bold text-emerald-600">0</h3>
                            </div>
                            <i class="fas fa-check-circle text-emerald-500 text-2xl"></i>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Ù…ÙƒØ±Ø±Ø©</p>
                                <h3 id="stat-duplicate" class="text-3xl font-bold text-red-600">0</h3>
                            </div>
                            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… -->
                <div id="admin-user-controls" class="hidden mb-8">
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-purple-800 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-white text-lg"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…</h2>
                        </div>
                        
                        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
                        <div class="tabs mb-6">
                            <div class="tab active" onclick="switchAdminTab('all-users')">
                                Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                            </div>
                            <div class="tab" onclick="switchAdminTab('focus-user')">
                                Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…
                            </div>
                            <div class="tab" onclick="switchAdminTab('user-stats')">
                                Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
                        <div id="tab-all-users" class="admin-tab-content">
                            <div class="admin-dashboard-controls" id="users-list-container">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… -->
                        <div id="tab-focus-user" class="admin-tab-content hidden">
                            <div id="focus-user-container">
                                <div class="text-center py-12 text-gray-500">
                                    <i class="fas fa-user text-3xl mb-3 text-gray-300"></i>
                                    <p class="text-lg font-medium">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§ØªÙ‡</p>
                                    <p class="text-sm text-gray-400 mt-2">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
                        <div id="tab-user-stats" class="admin-tab-content hidden">
                            <div id="user-stats-container">
                                <div class="text-center py-12 text-gray-500">
                                    <i class="fas fa-chart-bar text-3xl mb-3 text-gray-300"></i>
                                    <p class="text-lg font-medium">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
            <div id="user-section" class="hidden mb-8">
                <div class="glass-card rounded-2xl p-6 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                            <i class="fas fa-plus text-white text-lg"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                    </div>
                    
                    <form id="request-form" class="space-y-6">
                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø¬Ù†Ø³ ÙˆØ§Ù„Ø§Ø³Ù… -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user ml-1 text-gray-400"></i> Ø§Ù„Ø¬Ù†Ø³ *
                                </label>
                                <select id="gender" required class="w-full">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
                                    <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                                    <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user-tag ml-1 text-gray-400"></i> Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨
                                    <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="subject-name" 
                                    placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"
                                >
                            </div>
                        </div>

                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙˆØ§Ù„Ø§Ù†ØªØ³Ø§Ø¨ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-birthday-cake ml-1 text-gray-400"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ *
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-day" 
                                            required 
                                            min="1" 
                                            max="31"
                                            placeholder="ÙŠÙˆÙ…"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-month" 
                                            required 
                                            min="1" 
                                            max="12"
                                            placeholder="Ø´Ù‡Ø±"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-year" 
                                            required 
                                            min="1900" 
                                            max="2026"
                                            placeholder="Ø³Ù†Ø©"
                                            class="text-center"
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt ml-1 text-gray-400"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨
                                    <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-day" 
                                            min="1" 
                                            max="31"
                                            placeholder="ÙŠÙˆÙ…"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-month" 
                                            min="1" 
                                            max="12"
                                            placeholder="Ø´Ù‡Ø±"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-year" 
                                            min="1900" 
                                            max="2026"
                                            placeholder="Ø³Ù†Ø©"
                                            class="text-center"
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„ÙØ¦Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Ø§Ù„ÙØ¦Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-layer-group ml-1 text-gray-400"></i> Ø§Ù„ÙØ¦Ø©
                                    <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                </label>
                                <select id="category" class="w-full">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
                                    <option value="1">Ø§Ù„ÙØ¦Ø© 1</option>
                                    <option value="2">Ø§Ù„ÙØ¦Ø© 2</option>
                                    <option value="3">Ø§Ù„ÙØ¦Ø© 3</option>
                                    <option value="4">Ø§Ù„ÙØ¦Ø© 4</option>
                                    <option value="5">Ø§Ù„ÙØ¦Ø© 5</option>
                                    <option value="6">Ø§Ù„ÙØ¦Ø© 6</option>
                                    <option value="7">Ø§Ù„ÙØ¦Ø© 7</option>
                                    <option value="8">Ø§Ù„ÙØ¦Ø© 8</option>
                                    <option value="9">Ø§Ù„ÙØ¦Ø© 9</option>
                                    <option value="10">Ø§Ù„ÙØ¦Ø© 10</option>
                                    <option value="11">Ø§Ù„ÙØ¦Ø© 11</option>
                                    <option value="12">Ø§Ù„ÙØ¦Ø© 12</option>
                                    <option value="13">Ø§Ù„ÙØ¦Ø© 13</option>
                                    <option value="14">Ø§Ù„ÙØ¦Ø© 14</option>
                                    <option value="15">Ø§Ù„ÙØ¦Ø© 15</option>
                                </select>
                            </div>

                            <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-sticky-note ml-1 text-gray-400"></i> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                    <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                </label>
                                <textarea 
                                    id="notes" 
                                    rows="3" 
                                    placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
                        <div class="pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-image ml-1 text-gray-400"></i> Ø±ÙØ¹ ØµÙˆØ±Ø©
                                <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                            </label>
                            
                            <div id="image-upload-container">
                                <!-- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© -->
                                <div id="no-image-section" class="image-preview-container">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                    <p class="text-gray-600 mb-4">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª ØµÙˆØ±Ø© Ù‡Ù†Ø§ Ø£Ùˆ</p>
                                    <label for="image-upload" class="upload-btn">
                                        <i class="fas fa-image ml-1"></i> Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©
                                    </label>
                                    <input 
                                        type="file" 
                                        id="image-upload" 
                                        accept="image/*" 
                                        class="hidden"
                                        onchange="previewImage(event)"
                                    >
                                    <p class="text-xs text-gray-500 mt-3">Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: JPG, PNG, GIF (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 5MB)</p>
                                    <div class="compression-status">
                                        <i class="fas fa-compress-alt"></i>
                                        <span>Ø³ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ø¹ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…</span>
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© -->
                                <div id="image-preview-section" class="hidden">
                                    <div class="image-preview-container">
                                        <img id="image-preview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" class="image-preview">
                                        <div id="compression-info" class="compression-status"></div>
                                        <div class="image-actions">
                                            <label for="image-upload" class="upload-btn">
                                                <i class="fas fa-sync-alt ml-1"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
                                            </label>
                                            <button type="button" onclick="removeImage()" class="remove-image-btn">
                                                <i class="fas fa-trash ml-1"></i> Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
                        <div class="pt-4">
                            <button 
                                type="submit" 
                                id="submit-btn" 
                                class="w-full btn btn-primary py-4 rounded-2xl text-lg"
                            >
                                <i class="fas fa-search-check ml-2"></i> ÙØ­Øµ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© -->
            <div id="orders-section" class="glass-card rounded-2xl p-6 mb-6">
                <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                            <i class="fas fa-history text-blue-600"></i>
                            <span id="orders-section-title">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                        </h2>
                        <span id="duplicate-count" class="hidden bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">
                            <i class="fas fa-exclamation-triangle ml-1"></i>
                            <span id="duplicate-number">0</span> Ù…ÙƒØ±Ø±Ø©
                        </span>
                    </div>
                    
                    <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
                    <button 
                        id="back-to-all-users-btn" 
                        onclick="backToAllUsers()" 
                        class="hidden btn btn-secondary"
                    >
                        <i class="fas fa-arrow-right ml-1"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    </button>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full md:w-auto">
                        <div class="relative w-full sm:w-64">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input 
                                type="text" 
                                id="search-box" 
                                class="w-full p-3 pr-10 rounded-xl"
                                placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."
                            >
                        </div>
                        
                        <select 
                            id="filter-status" 
                            class="w-full sm:w-auto p-3 rounded-xl"
                        >
                            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                            <option value="Ù…ÙƒØªÙ…Ù„">Ù…ÙƒØªÙ…Ù„Ø©</option>
                            <option value="duplicate">Ù…ÙƒØ±Ø±Ø© ÙÙ‚Ø·</option>
                        </select>
                    </div>
                </div>

                <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø© -->
                <div id="filter-loading" class="filter-loading">
                    <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    <div class="spinner-small"></div>
                </div>

                <!-- Ø­Ø§ÙˆÙŠØ© Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
                <div id="orders-cards-container">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
    <div id="modal-reply" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨</h3>
                <button 
                    onclick="closeModal()" 
                    class="text-gray-400 hover:text-gray-600 text-2xl"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-content" class="space-y-4">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            
            <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
                <button 
                    onclick="closeModal()" 
                    class="flex-1 btn btn-secondary py-3"
                >
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button 
                    id="modal-save-btn" 
                    onclick="saveReply()" 
                    class="flex-1 btn btn-primary py-3"
                >
                    <i class="fas fa-check ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø±Ø¯
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙƒØ±Ø§Ø± -->
    <div id="duplicate-alert" class="alert-overlay hidden">
        <div class="alert-modal">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-14 h-14 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-black text-gray-800">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø·Ù„Ø¨ Ù…ÙƒØ±Ø±</h3>
                    <p class="text-gray-600 text-sm">ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø·Ù„Ø¨ Ù…Ø³Ø¨Ù‚ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!</p>
                </div>
            </div>
            
            <div class="space-y-4" id="duplicate-alert-content">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§ -->
            </div>
            
            <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
                <button 
                    onclick="closeDuplicateAlert()" 
                    class="flex-1 btn btn-secondary py-3"
                >
                    <i class="fas fa-times ml-2"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
                <button 
                    id="force-submit-btn" 
                    onclick="forceSubmitOrder()" 
                    class="flex-1 btn btn-danger py-3"
                >
                    <i class="fas fa-exclamation-triangle ml-2"></i> Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±
                </button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
    <div id="image-modal" class="image-modal hidden">
        <button onclick="closeImageModal()" class="close-image-modal">
            <i class="fas fa-times"></i>
        </button>
        <img id="full-size-image" src="" alt="Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="image-modal-content">
    </div>

    <!-- Ù…ÙƒØªØ¨Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ± -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOzouJz7ROysGrL2KoS6GPU046Mfq5EKg",
            authDomain: "damin-62c82.firebaseapp.com",
            databaseURL: "https://damin-62c82-default-rtdb.firebaseio.com",
            projectId: "damin-62c82",
            storageBucket: "damin-62c82.firebasestorage.app",
            messagingSenderId: "787751266614",
            appId: "1:787751266614:web:4045deaf010156db4eab97"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ
        const usersMap = {
            "0780": { name: "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…", role: "admin" },
            "2004": { name: "Ù…Ù‡Ø¯ÙŠ Ø£Ø­Ù…Ø¯", role: "user" },
            "1982": { name: "Ù…Ù‡Ù†Ø¯ Ø¹Ù„ÙŠ (Ø£Ø¨Ùˆ Ø³ÙŠÙ)", role: "user" },
            "2001": { name: "Ù…Ù‡Ø¯ÙŠ (Ø¯. Ø¥ÙŠÙ‡Ø§Ø¨)", role: "user" },
            "1996": { name: "Ø­ÙŠØ¯Ø± Ø§Ù„ÙƒØ±Ø¹Ø§ÙˆÙŠ", role: "user" },
            "1234": { name: "Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ", role: "user" },
            "2026": { name: "ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ", role: "user" }
        };

        let currentUser = null;
        let allOrders = [];
        let selectedOrderId = '';
        let currentNewOrderData = null;
        let duplicateOrders = [];
        let duplicateCount = 0;
        let notifications = [];
        let selectedImageFile = null;
        let imagePreviewUrl = null;
        let filterTimeout = null;
        let isFiltering = false;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        let currentFocusedUser = null;
        let currentAdminTab = 'all-users';
        let usersStats = {};

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…
        function showPushNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `push-notification notification-${type}`;
            
            let icon;
            switch(type) {
                case 'success': icon = 'fa-check-circle'; break;
                case 'warning': icon = 'fa-exclamation-triangle'; break;
                default: icon = 'fa-bell';
            }
            
            notification.innerHTML = `
                <div class="notification-icon ${type === 'success' ? 'notification-success' : type === 'warning' ? 'notification-warning' : 'notification-info'}">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800">${title}</h4>
                    <p class="text-sm text-gray-600">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Ø¯Ø§Ù„Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
        async function compressImage(file) {
            try {
                const options = {
                    maxSizeMB: 0.5, // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬Ù… 0.5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
                    maxWidthOrHeight: 1024, // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ø±Ø¶ Ø£Ùˆ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ 1024px
                    useWebWorker: true,
                    fileType: 'image/jpeg', // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ JPEG Ù„Ù„Ø¶ØºØ· Ø§Ù„Ø£ÙØ¶Ù„
                    initialQuality: 0.8, // Ø¬ÙˆØ¯Ø© 80% (Ù…ØªÙˆØ§Ø²Ù†Ø©)
                };
                
                const compressedFile = await imageCompression(file, options);
                
                // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶ØºØ·
                const originalSize = (file.size / 1024 / 1024).toFixed(2);
                const compressedSize = (compressedFile.size / 1024 / 1024).toFixed(2);
                const compressionRatio = Math.round((1 - (compressedFile.size / file.size)) * 100);
                
                return {
                    file: compressedFile,
                    originalSize: originalSize,
                    compressedSize: compressedSize,
                    compressionRatio: compressionRatio
                };
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©:', error);
                return {
                    file: file,
                    originalSize: (file.size / 1024 / 1024).toFixed(2),
                    compressedSize: (file.size / 1024 / 1024).toFixed(2),
                    compressionRatio: 0
                };
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.handleLogin = function() {
            const pass = document.getElementById('login-pass').value.trim();
            if (usersMap[pass]) {
                currentUser = usersMap[pass];
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
                const sessionData = {
                    ...currentUser,
                    loginTime: new Date().toISOString()
                };
                localStorage.setItem('user_session', JSON.stringify(sessionData));
                
                showDashboard();
                fetchNotifications();
                
                // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            showPushNotification('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', 'success');
                        }
                    });
                }
                
                showPushNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + currentUser.name, 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                alert("Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!");
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('user-display-name').innerText = currentUser.name;
            
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.innerText = currentUser.role === 'admin' ? "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…" : "Ù…Ø³ØªØ®Ø¯Ù…";
            roleBadge.className = currentUser.role === 'admin' 
                ? 'badge badge-success' 
                : 'badge badge-info';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            if (currentUser.role === 'admin') {
                document.getElementById('admin-stats').classList.remove('hidden');
                document.getElementById('admin-user-controls').classList.remove('hidden');
                document.getElementById('user-section').classList.add('hidden');
                document.getElementById('orders-section-title').innerText = 'Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª';
                document.getElementById('back-to-all-users-btn').classList.add('hidden');
            } else {
                document.getElementById('admin-stats').classList.add('hidden');
                document.getElementById('admin-user-controls').classList.add('hidden');
                document.getElementById('user-section').classList.remove('hidden');
                document.getElementById('orders-section-title').innerText = 'Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙƒ';
            }
            
            fetchOrders();
            setupSearchAndFilter();
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        window.refreshOrders = function() {
            fetchOrders();
            fetchNotifications();
            showPushNotification('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'info');
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function fetchNotifications() {
            if (!currentUser) return;
            
            onValue(ref(db, 'notifications'), (snapshot) => {
                const data = snapshot.val();
                notifications = [];
                
                if (data) {
                    for (let id in data) {
                        const notif = { id, ...data[id] };
                        
                        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
                        if (currentUser.role === 'admin' || 
                            (notif.targetUser === currentUser.name && !notif.read)) {
                            notifications.push(notif);
                        }
                    }
                }
                
                updateNotificationsUI();
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function updateNotificationsUI() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');
            
            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            } else {
                badge.classList.add('hidden');
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            showBrowserNotifications();
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
        function showBrowserNotifications() {
            if (!("Notification" in window)) return;
            
            const newNotifications = notifications.filter(n => 
                !n.read && 
                (n.type === 'new_order' || n.type === 'order_replied' || n.type === 'order_completed')
            );
            
            newNotifications.forEach(notif => {
                if (Notification.permission === "granted") {
                    let title, body;
                    
                    switch(notif.type) {
                        case 'new_order':
                            title = 'ğŸ“‹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
                            body = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${notif.sender}`;
                            break;
                        case 'order_replied':
                            title = 'ğŸ’¬ Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ';
                            body = `ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„`;
                            break;
                        case 'order_completed':
                            title = 'âœ… Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
                            body = `ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­`;
                            break;
                    }
                    
                    new Notification(title, {
                        body: body,
                        icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                        tag: notif.id
                    });
                    
                    // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ø¦Ù…
                    showPushNotification(title, body, 'info');
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡
                if (!notif.read) {
                    update(ref(db, 'notifications/' + notif.id), { read: true });
                }
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        window.toggleNotifications = function() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                displayNotificationsList();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function displayNotificationsList() {
            const listContainer = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-bell-slash text-3xl mb-3"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
                    </div>
                `;
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
            const sortedNotifications = [...notifications].sort((a, b) => b.timestamp - a.timestamp);
            
            let listHTML = '';
            sortedNotifications.forEach(notif => {
                const timeAgo = getTimeAgo(notif.timestamp);
                const isReadClass = notif.read ? 'opacity-70' : 'bg-blue-50';
                
                let icon, color, text;
                
                switch(notif.type) {
                    case 'new_order':
                        icon = 'fa-file-alt';
                        color = 'text-blue-600';
                        text = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${notif.sender}`;
                        break;
                    case 'order_replied':
                        icon = 'fa-reply';
                        color = 'text-green-600';
                        text = `Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ`;
                        break;
                    case 'order_completed':
                        icon = 'fa-check-circle';
                        color = 'text-emerald-600';
                        text = `ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ`;
                        break;
                    case 'duplicate_warning':
                        icon = 'fa-exclamation-triangle';
                        color = 'text-red-600';
                        text = `ØªÙ†Ø¨ÙŠÙ‡: Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± Ù…Ù† ${notif.sender}`;
                        break;
                    default:
                        icon = 'fa-bell';
                        color = 'text-gray-600';
                        text = notif.message || 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯';
                }
                
                listHTML += `
                    <div class="notification-item p-3 border-b border-gray-100 hover:bg-gray-50 ${isReadClass}" onclick="markNotificationAsRead('${notif.id}')">
                        <div class="flex items-start gap-3">
                            <div class="${color}">
                                <i class="fas ${icon} text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${text}</p>
                                ${notif.orderSubject ? `
                                    <p class="text-xs text-gray-600 mt-1">Ø§Ù„Ø·Ù„Ø¨: ${notif.orderSubject}</p>
                                ` : ''}
                                <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                            </div>
                            ${!notif.read ? `
                                <span class="w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = listHTML;
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
            if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
            return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡
        window.markNotificationAsRead = function(notificationId) {
            update(ref(db, 'notifications/' + notificationId), { read: true })
                .then(() => {
                    fetchNotifications();
                });
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
        window.markAllNotificationsAsRead = function() {
            notifications.forEach(notif => {
                if (!notif.read) {
                    update(ref(db, 'notifications/' + notif.id), { read: true });
                }
            });
            showPushNotification('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡', 'ØªÙ…Øª Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'success');
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        function sendNotification(type, targetUser, sender, orderSubject = '', orderId = '') {
            const notificationData = {
                type: type,
                targetUser: targetUser,
                sender: sender,
                orderSubject: orderSubject,
                orderId: orderId,
                timestamp: Date.now(),
                read: false
            };
            
            push(ref(db, 'notifications'), notificationData);
            
            // Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
            if (currentUser && (currentUser.name === targetUser || currentUser.role === 'admin')) {
                let title, message;
                switch(type) {
                    case 'new_order':
                        title = 'ğŸ“‹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
                        message = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${sender}`;
                        break;
                    case 'order_replied':
                        title = 'ğŸ’¬ Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ';
                        message = `ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„`;
                        break;
                    case 'order_completed':
                        title = 'âœ… Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
                        message = `ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­`;
                        break;
                    case 'duplicate_warning':
                        title = 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ ØªÙƒØ±Ø§Ø±';
                        message = `ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± Ù…Ù† ${sender}`;
                        break;
                }
                
                showPushNotification(title, message, type === 'duplicate_warning' ? 'warning' : 'info');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ø¶ØºØ·
        window.previewImage = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            if (!file.type.match('image.*')) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
            if (file.size > 5 * 1024 * 1024) {
                alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 5MB');
                return;
            }
            
            // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const btn = document.getElementById('submit-btn');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-compress-alt fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©...';
            
            try {
                // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
                const compressionResult = await compressImage(file);
                selectedImageFile = compressionResult.file;
                
                // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¶ØºØ·
                const compressionInfo = document.getElementById('compression-info');
                if (compressionResult.compressionRatio > 0) {
                    compressionInfo.innerHTML = `
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span>ØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©: ${compressionResult.originalSize}MB â†’ ${compressionResult.compressedSize}MB (Ù†Ø³Ø¨Ø© Ø¶ØºØ·: ${compressionResult.compressionRatio}%)</span>
                        <span class="compression-badge">Ù…Ø¶ØºÙˆØ·Ø©</span>
                    `;
                } else {
                    compressionInfo.innerHTML = `
                        <i class="fas fa-info-circle text-blue-500"></i>
                        <span>Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©: ${compressionResult.originalSize}MB</span>
                    `;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ URL Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                imagePreviewUrl = URL.createObjectURL(selectedImageFile);
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                const previewImg = document.getElementById('image-preview');
                previewImg.src = imagePreviewUrl;
                
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                document.getElementById('no-image-section').classList.add('hidden');
                document.getElementById('image-preview-section').classList.remove('hidden');
                
                showPushNotification('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'ØªÙ…Øª Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        };

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©
        window.removeImage = function() {
            selectedImageFile = null;
            if (imagePreviewUrl) {
                URL.revokeObjectURL(imagePreviewUrl);
                imagePreviewUrl = null;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø±ÙØ¹
            document.getElementById('image-upload').value = '';
            
            // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            document.getElementById('no-image-section').classList.remove('hidden');
            document.getElementById('image-preview-section').classList.add('hidden');
            
            showPushNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©', 'info');
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
        function checkForDuplicates(newOrder) {
            duplicateOrders = [];
            
            allOrders.forEach(existingOrder => {
                // 1. Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¬Ù†Ø³ (Ù…Ø·Ù„ÙˆØ¨)
                const genderMatch = newOrder.gender === existingOrder.gender;
                
                // 2. Ù…Ù‚Ø§Ø±Ù†Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù…Ø·Ù„ÙˆØ¨)
                const birthMatch = newOrder.birth === existingOrder.birth;
                
                // 3. Ù…Ù‚Ø§Ø±Ù†Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ø·Ù„Ø¨ÙŠÙ†)
                let joinMatch = false;
                if (newOrder.joinDate && existingOrder.joinDate) {
                    // ÙƒÙ„Ø§ Ø§Ù„Ø·Ù„Ø¨ÙŠÙ† ÙŠØ­ØªÙˆÙŠØ§Ù† Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªØ³Ø§Ø¨ - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ·Ø§Ø¨Ù‚Ø§
                    joinMatch = newOrder.joinDate === existingOrder.joinDate;
                } else if (!newOrder.joinDate && !existingOrder.joinDate) {
                    // ÙƒÙ„Ø§Ù‡Ù…Ø§ ÙØ§Ø±Øº - ÙŠØ¹ØªØ¨Ø± ØªØ·Ø§Ø¨Ù‚
                    joinMatch = true;
                } else if (!newOrder.joinDate || !existingOrder.joinDate) {
                    // Ø£Ø­Ø¯Ù‡Ù…Ø§ ÙØ§Ø±Øº ÙˆØ§Ù„Ø¢Ø®Ø± Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ - Ù„Ø§ ÙŠØ¹ØªØ¨Ø± ØªØ·Ø§Ø¨Ù‚ (ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„)
                    joinMatch = false;
                }
                
                // 4. Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙØ¦Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ø·Ù„Ø¨ÙŠÙ†)
                let categoryMatch = false;
                if (newOrder.category && existingOrder.category) {
                    // ÙƒÙ„Ø§ Ø§Ù„Ø·Ù„Ø¨ÙŠÙ† ÙŠØ­ØªÙˆÙŠØ§Ù† Ø¹Ù„Ù‰ ÙØ¦Ø© - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ·Ø§Ø¨Ù‚Ø§
                    categoryMatch = newOrder.category === existingOrder.category;
                } else if (!newOrder.category && !existingOrder.category) {
                    // ÙƒÙ„Ø§Ù‡Ù…Ø§ ÙØ§Ø±Øº - ÙŠØ¹ØªØ¨Ø± ØªØ·Ø§Ø¨Ù‚
                    categoryMatch = true;
                } else if (!newOrder.category || !existingOrder.category) {
                    // Ø£Ø­Ø¯Ù‡Ù…Ø§ ÙØ§Ø±Øº ÙˆØ§Ù„Ø¢Ø®Ø± Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ - Ù„Ø§ ÙŠØ¹ØªØ¨Ø± ØªØ·Ø§Ø¨Ù‚ (ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„)
                    categoryMatch = false;
                }
                
                // Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¥Ø°Ø§ ØªØ·Ø§Ø¨Ù‚Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
                if (genderMatch && birthMatch && joinMatch && categoryMatch) {
                    duplicateOrders.push(existingOrder);
                }
            });
            
            return duplicateOrders.length > 0;
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
        document.getElementById('request-form').onsubmit = async (e) => {
            e.preventDefault();
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const gender = document.getElementById('gender').value;
            const subjectName = document.getElementById('subject-name').value.trim();
            const category = document.getElementById('category').value;
            const bDay = document.getElementById('b-day').value;
            const bMonth = document.getElementById('b-month').value;
            const bYear = document.getElementById('b-year').value;
            const jDay = document.getElementById('j-day').value;
            const jMonth = document.getElementById('j-month').value;
            const jYear = document.getElementById('j-year').value;
            const notes = document.getElementById('notes').value.trim();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø¬Ù†Ø³ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙÙ‚Ø·)
            if (!gender || !bDay || !bMonth || !bYear) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø¬Ù†Ø³ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)");
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª (ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ø³Ù…)
            if (!subjectName && !selectedImageFile) {
                if (!confirm("Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ø³Ù… Ù„Ù„Ø·Ù„Ø¨. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) {
                    return;
                }
            }
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const birthDate = `${bDay}/${bMonth}/${bYear}`;
            let joinDate = '';
            if (jDay && jMonth && jYear) {
                joinDate = `${jDay}/${jMonth}/${jYear}`;
            }
            
            const newOrderData = {
                sender: currentUser.name,
                gender: gender,
                subjectName: subjectName || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                category: category || '',
                birth: birthDate,
                joinDate: joinDate,
                notes: notes,
                status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                reply: "",
                adminNotes: "",
                timestamp: new Date().toLocaleString('ar-EG'),
                timestampOrder: Date.now(),
                senderId: currentUser.name.replace(/\s+/g, '_') + '_' + Date.now(),
                // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©
                statusTimeline: {
                    pending: {
                        status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                        time: new Date().toLocaleString('ar-EG'),
                        timestamp: Date.now()
                    }
                }
            };
            
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
            currentNewOrderData = newOrderData;
            
            // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const hasDuplicates = checkForDuplicates(newOrderData);
            
            if (hasDuplicates) {
                // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                showDuplicateAlert(duplicateOrders, newOrderData);
            } else {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø±ØŒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                await submitOrder(newOrderData, selectedImageFile);
            }
        };

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙƒØ±Ø§Ø± (Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·)
        function showDuplicateAlert(duplicates, newOrder) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨
            if (currentUser.role !== 'admin' && newOrder.sender !== currentUser.name) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ ÙˆÙ„ÙŠØ³ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨ØŒ ØªØ®Ø·ÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                submitOrder(newOrder, selectedImageFile);
                return;
            }
            
            let alertContent = `
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                    <p class="font-bold text-red-700 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„Ø¬Ù†Ø³:</span>
                            <span class="font-bold">${newOrder.gender}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span>
                            <span class="font-bold">${newOrder.birth}</span>
                        </div>
                        ${newOrder.joinDate ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨:</span>
                            <span class="font-bold">${newOrder.joinDate}</span>
                        </div>
                        ` : ''}
                        ${newOrder.category ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„ÙØ¦Ø©:</span>
                            <span class="font-bold">ÙØ¦Ø© ${newOrder.category}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <p class="font-bold text-amber-700 mb-3">
                        <i class="fas fa-exclamation-circle ml-1"></i>
                        ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${duplicates.length} Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± Ø³Ø§Ø¨Ù‚Ø§Ù‹:
                    </p>
            `;
            
            duplicates.forEach((dup, index) => {
                const duplicateDate = new Date(dup.timestampOrder).toLocaleString('ar-EG');
                alertContent += `
                    <div class="mb-3 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-gray-800">${index + 1}. ${dup.subjectName}</span>
                            <span class="text-xs text-gray-500">${duplicateDate}</span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex justify-between">
                                <span>Ø§Ù„Ù…Ø±Ø³Ù„:</span>
                                <span class="font-bold">${dup.sender}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</span>
                                <span class="font-bold ${dup.status === 'Ù…ÙƒØªÙ…Ù„' ? 'text-green-600' : 'text-amber-600'}">${dup.status}</span>
                            </div>
                            ${dup.reply ? `
                            <div class="mt-2">
                                <span class="text-gray-500">Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span>
                                <p class="text-gray-700 text-xs mt-1 bg-gray-100 p-2 rounded">${dup.reply.substring(0, 100)}${dup.reply.length > 100 ? '...' : ''}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            alertContent += `
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mt-4">
                    <p class="text-blue-700 text-sm flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        <span>Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆÙ…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±</span>
                    </p>
                </div>
            `;
            
            document.getElementById('duplicate-alert-content').innerHTML = alertContent;
            document.getElementById('duplicate-alert').classList.remove('hidden');
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù…Ø³Ø¤ÙˆÙ„
            if (currentUser.role !== 'admin') {
                sendDuplicateNotificationToAdmins(newOrder, duplicates);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙƒØ±Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·
        function sendDuplicateNotificationToAdmins(newOrder, duplicates) {
            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·
            sendNotification('duplicate_warning', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', currentUser.name, newOrder.subjectName);
            
            const notificationData = {
                type: 'duplicate_warning',
                newOrder: newOrder,
                duplicateCount: duplicates.length,
                timestamp: Date.now(),
                notifiedAdmins: true,
                // ØªØ­Ø¯ÙŠØ¯ Ø£Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·
                forAdminOnly: true
            };
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
            try {
                push(ref(db, 'admin_notifications'), notificationData);
            } catch (error) {
                console.log("ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªÙƒØ±Ø§Ø±ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†:", error);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø³Ø±ÙŠ (Ù…Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±)
        window.forceSubmitOrder = async function() {
            if (!currentNewOrderData) return;
            
            const btn = document.getElementById('force-submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙƒØ±Ø±
            currentNewOrderData.isDuplicate = true;
            currentNewOrderData.duplicateWarning = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± ${duplicateOrders.length} Ù…Ø±Ø© Ø³Ø§Ø¨Ù‚Ø©`;
            currentNewOrderData.duplicateReferences = duplicateOrders.map(d => d.id);
            
            try {
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64 Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (selectedImageFile) {
                    try {
                        const base64Image = await convertImageToBase64(selectedImageFile);
                        currentNewOrderData.imageData = base64Image;
                        currentNewOrderData.hasImage = true;
                        currentNewOrderData.imageName = selectedImageFile.name;
                    } catch (imageError) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:', imageError);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ù„ØµÙˆØ±Ø©.');
                    }
                }
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                await push(ref(db, 'orders'), currentNewOrderData);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                sendNotification('new_order', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', currentUser.name, currentNewOrderData.subjectName);
                
                showPushNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ ØªØ­Ø°ÙŠØ± Ø§Ù„ØªÙƒØ±Ø§Ø± (${duplicateOrders.length} Ù…ÙƒØ±Ø±)`, 'success');
                
                // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                closeDuplicateAlert();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('request-form').reset();
                removeImage();
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                fetchOrders();
            } catch (error) {
                showPushNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', error.message, 'warning');
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle ml-2"></i> Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±';
            }
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
        async function submitOrder(orderData, imageFile, isForceSubmit = false) {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            try {
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64 Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (imageFile) {
                    try {
                        const base64Image = await convertImageToBase64(imageFile);
                        orderData.imageData = base64Image;
                        orderData.hasImage = true;
                        orderData.imageName = imageFile.name;
                    } catch (imageError) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:', imageError);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ù„ØµÙˆØ±Ø©.');
                    }
                }
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                await push(ref(db, 'orders'), orderData);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                sendNotification('new_order', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', currentUser.name, orderData.subjectName);
                
                if (!isForceSubmit) {
                    showPushNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    document.getElementById('request-form').reset();
                    removeImage();
                } else {
                    showPushNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ ØªØ­Ø°ÙŠØ± Ø§Ù„ØªÙƒØ±Ø§Ø± (${duplicateOrders.length} Ù…ÙƒØ±Ø±)`, 'success');
                }
                
                fetchOrders();
            } catch (error) {
                console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨:", error);
                showPushNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', error.message, 'warning');
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search-check ml-2"></i> ÙØ­Øµ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
        window.closeDuplicateAlert = function() {
            document.getElementById('duplicate-alert').classList.add('hidden');
            currentNewOrderData = null;
            duplicateOrders = [];
        };

        // Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„
        window.openImageModal = function(imageUrl) {
            document.getElementById('full-size-image').src = imageUrl;
            document.getElementById('image-modal').classList.remove('hidden');
        };

        // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©
        window.closeImageModal = function() {
            document.getElementById('image-modal').classList.add('hidden');
            document.getElementById('full-size-image').src = '';
        };

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        function fetchOrders() {
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                allOrders = [];
                duplicateCount = 0;
                let stats = { total: 0, pending: 0, done: 0, duplicate: 0 };
                
                if (data) {
                    for (let id in data) {
                        const order = { id, ...data[id] };
                        allOrders.push(order);
                        stats.total++;
                        if (order.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") stats.pending++; else stats.done++;
                        
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
                        if (order.isDuplicate) {
                            duplicateCount++;
                        }
                    }
                    
                    // Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                    detectExistingDuplicates();
                    
                    // ØªØ­Ù„ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    analyzeUsersStats();
                    
                    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
                    allOrders.sort((a, b) => (b.timestampOrder || 0) - (a.timestampOrder || 0));
                }
                
                stats.duplicate = duplicateCount;
                displayOrders(allOrders);
                updateStats(stats);
                
                // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                if (currentUser.role === 'admin') {
                    updateAdminDashboard();
                }
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function analyzeUsersStats() {
            usersStats = {};
            
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            allOrders.forEach(order => {
                if (!usersStats[order.sender]) {
                    usersStats[order.sender] = {
                        total: 0,
                        pending: 0,
                        completed: 0,
                        duplicates: 0,
                        lastOrderDate: order.timestamp,
                        orders: []
                    };
                }
                
                usersStats[order.sender].total++;
                usersStats[order.sender].orders.push(order);
                
                if (order.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") {
                    usersStats[order.sender].pending++;
                } else {
                    usersStats[order.sender].completed++;
                }
                
                if (order.isDuplicate) {
                    usersStats[order.sender].duplicates++;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ø·Ù„Ø¨
                if (order.timestampOrder > (usersStats[order.sender].lastOrderTimestamp || 0)) {
                    usersStats[order.sender].lastOrderDate = order.timestamp;
                    usersStats[order.sender].lastOrderTimestamp = order.timestampOrder;
                }
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
        function updateAdminDashboard() {
            if (currentAdminTab === 'all-users') {
                displayUsersList();
            } else if (currentAdminTab === 'user-stats') {
                displayUserStatistics();
            }
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
            if (currentFocusedUser) {
                displayFocusedUserOrders();
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function displayUsersList() {
            const container = document.getElementById('users-list-container');
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙØ¹Ù„ÙŠÙŠÙ† Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            const activeUsers = Object.keys(usersStats);
            
            if (activeUsers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-users text-3xl mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯</p>
                    </div>
                `;
                return;
            }
            
            let usersHTML = '';
            
            activeUsers.forEach(userName => {
                const stats = usersStats[userName];
                const isCurrentFocused = currentFocusedUser === userName;
                
                usersHTML += `
                    <div class="user-selection-card ${isCurrentFocused ? 'active' : ''}" 
                         onclick="focusOnUser('${userName}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-gray-800">${userName}</h4>
                                <p class="text-sm text-gray-600">${stats.total} Ø·Ù„Ø¨</p>
                            </div>
                            <div class="text-xs text-gray-500">Ø¢Ø®Ø± Ø·Ù„Ø¨: ${stats.lastOrderDate}</div>
                        </div>
                        <div class="user-stats">
                            <span class="user-stat pending">${stats.pending} Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                            <span class="user-stat completed">${stats.completed} Ù…ÙƒØªÙ…Ù„</span>
                            ${stats.duplicates > 0 ? `<span class="user-stat duplicate">${stats.duplicates} Ù…ÙƒØ±Ø±</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = usersHTML;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ÙŠÙ†
        window.focusOnUser = function(userName) {
            currentFocusedUser = userName;
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('orders-section-title').innerText = `Ø·Ù„Ø¨Ø§Øª ${userName}`;
            document.getElementById('back-to-all-users-btn').classList.remove('hidden');
            
            // ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…
            switchAdminTab('focus-user');
            
            // Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯
            displayFocusedUserOrders();
            
            showPushNotification(`Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ${userName}`, `Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯`, 'info');
        };

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯
        function displayFocusedUserOrders() {
            const container = document.getElementById('focus-user-container');
            
            if (!currentFocusedUser) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-user text-3xl mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§ØªÙ‡</p>
                    </div>
                `;
                return;
            }
            
            const userStats = usersStats[currentFocusedUser];
            if (!userStats) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-user-times text-3xl mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
                    </div>
                `;
                return;
            }
            
            const orders = userStats.orders;
            orders.sort((a, b) => (b.timestampOrder || 0) - (a.timestampOrder || 0));
            
            // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ù„Ø¨Ø§Øª
            let ordersHTML = `
                <div class="focus-user-header">
                    <div class="focus-user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">${currentFocusedUser}</h3>
                            <div class="flex gap-4 mt-2">
                                <div class="text-center">
                                    <div class="text-2xl font-bold">${userStats.total}</div>
                                    <div class="text-sm opacity-90">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold">${userStats.pending}</div>
                                    <div class="text-sm opacity-90">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold">${userStats.completed}</div>
                                    <div class="text-sm opacity-90">Ù…ÙƒØªÙ…Ù„</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="backToAllUsers()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-50">
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
                    </button>
                </div>
            `;
            
            if (orders.length === 0) {
                ordersHTML += `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
                    </div>
                `;
            } else {
                // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                const pendingOrders = orders.filter(o => o.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
                const completedOrders = orders.filter(o => o.status === "Ù…ÙƒØªÙ…Ù„");
                
                if (pendingOrders.length > 0) {
                    ordersHTML += `
                        <div class="section-divider">
                            <div class="section-title pending-section">
                                <i class="fas fa-clock ml-2"></i>
                                Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (${pendingOrders.length})
                            </div>
                        </div>
                    `;
                    
                    pendingOrders.forEach(order => {
                        ordersHTML += generateOrderCardHTML(order);
                    });
                }
                
                if (completedOrders.length > 0) {
                    ordersHTML += `
                        <div class="section-divider">
                            <div class="section-title completed-section">
                                <i class="fas fa-check-circle ml-2"></i>
                                Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (${completedOrders.length})
                            </div>
                        </div>
                    `;
                    
                    completedOrders.forEach(order => {
                        ordersHTML += generateOrderCardHTML(order);
                    });
                }
            }
            
            container.innerHTML = ordersHTML;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        window.backToAllUsers = function() {
            currentFocusedUser = null;
            document.getElementById('orders-section-title').innerText = 'Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª';
            document.getElementById('back-to-all-users-btn').classList.add('hidden');
            switchAdminTab('all-users');
            displayOrders(allOrders);
        };

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function displayUserStatistics() {
            const container = document.getElementById('user-stats-container');
            
            const activeUsers = Object.keys(usersStats);
            if (activeUsers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-chart-bar text-3xl mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                    </div>
                `;
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            const sortedUsers = activeUsers.sort((a, b) => usersStats[b].total - usersStats[a].total);
            
            let statsHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th scope="col" class="px-6 py-3 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                                <th scope="col" class="px-6 py-3 text-center">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
                                <th scope="col" class="px-6 py-3 text-center">Ù…ÙƒØªÙ…Ù„</th>
                                <th scope="col" class="px-6 py-3 text-center">Ù…ÙƒØ±Ø±</th>
                                <th scope="col" class="px-6 py-3 text-center">Ø¢Ø®Ø± Ø·Ù„Ø¨</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedUsers.forEach(userName => {
                const stats = usersStats[userName];
                statsHTML += `
                    <tr class="bg-white border-b hover:bg-gray-50 cursor-pointer" onclick="focusOnUser('${userName}')">
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                            ${userName}
                        </th>
                        <td class="px-6 py-4 text-center font-bold">${stats.total}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${stats.pending > 0 ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-800'}">
                                ${stats.pending}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${stats.completed > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${stats.completed}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${stats.duplicates > 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                ${stats.duplicates}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center text-xs text-gray-500">${stats.lastOrderDate}</td>
                    </tr>
                `;
            });
            
            statsHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = statsHTML;
        }

        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
        window.switchAdminTab = function(tabName) {
            currentAdminTab = tabName;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            if (tabName === 'all-users') {
                displayUsersList();
            } else if (tabName === 'user-stats') {
                displayUserStatistics();
            } else if (tabName === 'focus-user') {
                if (currentFocusedUser) {
                    displayFocusedUserOrders();
                }
            }
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        function detectExistingDuplicates() {
            const duplicatesMap = new Map();
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªÙˆØ­ ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø·Ù„Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
            allOrders.forEach(order => {
                const key = `${order.gender}_${order.birth}_${order.joinDate || 'nojoin'}_${order.category || 'nocat'}`;
                
                if (!duplicatesMap.has(key)) {
                    duplicatesMap.set(key, []);
                }
                duplicatesMap.get(key).push(order);
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø±
            duplicatesMap.forEach(orders => {
                if (orders.length > 1) {
                    orders.forEach(order => {
                        order.hasDuplicates = true;
                        order.duplicateGroup = orders.filter(o => o.id !== order.id);
                    });
                }
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ ØªØ±ØªÙŠØ¨ Ù…Ø­Ø³Ù‘Ù†
        function displayOrders(orders) {
            if (isFiltering) {
                return; // ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
            }
            
            const container = document.getElementById('orders-cards-container');
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const filter = document.getElementById('filter-status').value;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
            const isMobile = window.innerWidth < 768;
            const loadingIndicator = document.getElementById('filter-loading');
            
            if (isMobile) {
                isFiltering = true;
                loadingIndicator.classList.add('active');
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„ØªØ¬Ù†Ø¨ ØªØ¬Ù…ÙŠØ¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                setTimeout(() => {
                    performFilterAndDisplay(orders, container, searchTerm, filter, isMobile);
                }, 50);
            } else {
                performFilterAndDisplay(orders, container, searchTerm, filter, isMobile);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶
        function performFilterAndDisplay(orders, container, searchTerm, filter, isMobile) {
            try {
                // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                let filteredOrders = orders.filter(o => {
                    if (currentUser.role === 'admin' && currentFocusedUser) {
                        // Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…
                        if (o.sender !== currentFocusedUser) return false;
                    } else if (currentUser.role !== 'admin' && o.sender !== currentUser.name) {
                        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠØ±Ù‰ ÙÙ‚Ø· Ø·Ù„Ø¨Ø§ØªÙ‡
                        return false;
                    }
                    
                    if (searchTerm && !o.subjectName.toLowerCase().includes(searchTerm) && !o.notes.toLowerCase().includes(searchTerm)) return false;
                    if (filter === 'duplicate' && !o.isDuplicate && !o.hasDuplicates) return false;
                    if (filter && filter !== 'duplicate' && o.status !== filter) return false;
                    return true;
                });
                
                // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
                filteredOrders.sort((a, b) => {
                    // Ø£ÙˆÙ„Ø§Ù‹: ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹)
                    if (a.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' && b.status !== 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©') return -1;
                    if (a.status !== 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' && b.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©') return 1;
                    
                    // Ø«Ø§Ù†ÙŠØ§Ù‹: ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                    return (b.timestampOrder || 0) - (a.timestampOrder || 0);
                });
                
                if (filteredOrders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
                        </div>
                    `;
                    updateDuplicateCounter();
                    isFiltering = false;
                    document.getElementById('filter-loading').classList.remove('active');
                    return;
                }
                
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø£Ù‚Ø³Ø§Ù…
                let cardsHTML = '';
                let hasPending = false;
                let hasCompleted = false;
                
                // Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                let pendingOrders = filteredOrders.filter(o => o.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
                if (pendingOrders.length > 0 && (!filter || filter === '' || filter === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')) {
                    hasPending = true;
                    cardsHTML += `
                        <div class="section-divider">
                            <div class="section-title pending-section">
                                <i class="fas fa-clock ml-2"></i>
                                Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (${pendingOrders.length})
                            </div>
                        </div>
                    `;
                    
                    pendingOrders.forEach((order) => {
                        cardsHTML += generateOrderCardHTML(order);
                    });
                }
                
                // Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
                let completedOrders = filteredOrders.filter(o => o.status === 'Ù…ÙƒØªÙ…Ù„');
                if (completedOrders.length > 0 && (!filter || filter === '' || filter === 'Ù…ÙƒØªÙ…Ù„')) {
                    hasCompleted = true;
                    if (hasPending) {
                        cardsHTML += `
                            <div class="section-divider">
                                <div class="section-title completed-section">
                                    <i class="fas fa-check-circle ml-2"></i>
                                    Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (${completedOrders.length})
                                </div>
                            </div>
                        `;
                    } else {
                        cardsHTML += `
                            <div class="section-divider">
                                <div class="section-title completed-section">
                                    <i class="fas fa-check-circle ml-2"></i>
                                    Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (${completedOrders.length})
                                </div>
                            </div>
                        `;
                    }
                    
                    completedOrders.forEach((order) => {
                        cardsHTML += generateOrderCardHTML(order);
                    });
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± Ù…Ø­Ø¯Ø¯ ÙˆÙ„Ù… ØªØ¸Ù‡Ø± Ø£ÙŠ Ø£Ù‚Ø³Ø§Ù…
                if ((filter === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' && !hasPending) || (filter === 'Ù…ÙƒØªÙ…Ù„' && !hasCompleted)) {
                    const filterName = filter === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©';
                    cardsHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ${filterName}</p>
                        </div>
                    `;
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ù„Ù„Ø£Ø¯Ø§Ø¡
                if (isMobile) {
                    // Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… requestAnimationFrame Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
                    requestAnimationFrame(() => {
                        container.innerHTML = cardsHTML;
                        updateDuplicateCounter();
                        isFiltering = false;
                        document.getElementById('filter-loading').classList.remove('active');
                    });
                } else {
                    container.innerHTML = cardsHTML;
                    updateDuplicateCounter();
                    isFiltering = false;
                    document.getElementById('filter-loading').classList.remove('active');
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", error);
                container.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p class="text-lg font-medium">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                        <p class="text-sm mt-2">ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</p>
                    </div>
                `;
                isFiltering = false;
                document.getElementById('filter-loading').classList.remove('active');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨
        function generateOrderCardHTML(order) {
            const isDuplicate = order.isDuplicate || order.hasDuplicates;
            const statusClass = order.status === 'Ù…ÙƒØªÙ…Ù„' ? 'completed' : 'pending';
            const duplicateClass = isDuplicate ? 'duplicate' : '';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆÙ…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨
            let showDuplicateBadge = false;
            if (isDuplicate) {
                if (currentUser.role === 'admin' || order.sender === currentUser.name) {
                    showDuplicateBadge = true;
                }
            }
            
            const statusBadge = order.status === 'Ù…ÙƒØªÙ…Ù„' 
                ? '<span class="badge badge-success"><i class="fas fa-check-circle ml-1"></i> Ù…ÙƒØªÙ…Ù„</span>'
                : '<span class="badge badge-warning"><i class="fas fa-clock ml-1"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
            
            const duplicateBadge = showDuplicateBadge ? `
                <div class="duplicate-badge">
                    <i class="fas fa-exclamation-triangle"></i>
                    Ù…ÙƒØ±Ø±
                </div>
            ` : '';
            
            const categoryDisplay = order.category 
                ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold">ÙØ¦Ø© ${order.category}</span>`
                : '<span class="text-gray-400">-</span>';
            
            const joinDateDisplay = order.joinDate 
                ? order.joinDate 
                : '<span class="text-gray-400">-</span>';
            
            const notesDisplay = order.notes 
                ? `<div class="mt-2 p-3 bg-gray-50 rounded-lg">
                      <span class="text-xs text-gray-500 font-medium">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„:</span>
                      <p class="text-gray-700 text-sm mt-1">${order.notes}</p>
                   </div>`
                : '';
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
            let imageDisplay = '';
            if (order.imageData) {
                imageDisplay = `
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">
                                <i class="fas fa-image ml-1"></i> Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©:
                            </span>
                            <span class="text-xs text-gray-500">${order.imageName || ''}</span>
                        </div>
                        <img src="${order.imageData}" 
                             alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨" 
                             class="order-image"
                             onclick="openImageModal('${order.imageData}')"
                             title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                    </div>
                `;
            }
            
            // ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨
            let statusTimelineHTML = '';
            if (order.statusTimeline) {
                statusTimelineHTML = generateStatusTimelineHTML(order.statusTimeline);
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                statusTimelineHTML = generateDefaultTimelineHTML(order);
            }
            
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø± (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆÙ…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨)
            let duplicateInfo = '';
            if (showDuplicateBadge) {
                const duplicateMsg = order.isDuplicate 
                    ? '<p class="text-red-600 text-sm font-bold mt-2"><i class="fas fa-exclamation-triangle ml-1"></i> ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ ØªØ­Ø°ÙŠØ± Ø§Ù„ØªÙƒØ±Ø§Ø±</p>'
                    : '<p class="text-amber-600 text-sm font-bold mt-2"><i class="fas fa-clone ml-1"></i> Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨Ø§Øª Ø£Ø®Ø±Ù‰ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                
                duplicateInfo = `
                    <div class="mt-3 p-3 border border-red-200 rounded-lg bg-red-50">
                        <p class="text-red-700 text-sm font-bold flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            ØªÙ†Ø¨ÙŠÙ‡: Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
                        </p>
                        ${duplicateMsg}
                    </div>
                `;
            }
            
            // Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¥Ù† ÙˆØ¬Ø¯Øª
            const adminNotesDisplay = order.adminNotes ? `
                <div class="mt-4 p-4 bg-purple-50 rounded-xl">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-purple-700">
                            <i class="fas fa-sticky-note ml-1"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:
                        </span>
                    </div>
                    <div class="admin-notes-content">
                        ${order.adminNotes}
                    </div>
                </div>
            ` : '';
            
            let actionsHTML = '';
            if (currentUser.role === 'admin') {
                actionsHTML = `
                    <div class="flex gap-2 mt-4">
                        <button onclick="openReplyModal('${order.id}')" class="flex-1 btn btn-primary py-2 text-sm">
                            <i class="fas fa-reply ml-1"></i> Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="btn btn-danger px-4">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else if (order.sender === currentUser.name && order.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") {
                actionsHTML = `
                    <div class="flex gap-2 mt-4">
                        <button onclick="deleteOrder('${order.id}')" class="flex-1 btn btn-danger py-2 text-sm">
                            <i class="fas fa-trash ml-1"></i> Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="order-card ${statusClass} ${duplicateClass}" data-id="${order.id}">
                    ${duplicateBadge}
                    
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-lg">${order.subjectName}</h4>
                            <p class="text-gray-600 text-sm mt-1">
                                <i class="far fa-user ml-1"></i> ${order.sender}
                            </p>
                        </div>
                        <div class="flex flex-col items-end">
                            ${statusBadge}
                            <span class="text-xs text-gray-500 mt-2">${order.timestamp}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="order-info-row">
                            <span class="label">Ø§Ù„Ø¬Ù†Ø³:</span>
                            <span class="value">${order.gender || '-'}</span>
                        </div>
                        <div class="order-info-row">
                            <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span>
                            <span class="value">${order.birth || '-'}</span>
                        </div>
                        <div class="order-info-row">
                            <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨:</span>
                            <span class="value">${joinDateDisplay}</span>
                        </div>
                        <div class="order-info-row">
                            <span class="label">Ø§Ù„ÙØ¦Ø©:</span>
                            <span class="value">${categoryDisplay}</span>
                        </div>
                    </div>
                    
                    ${imageDisplay}
                    ${notesDisplay}
                    ${statusTimelineHTML}
                    ${duplicateInfo}
                    
                    <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-blue-700">
                                <i class="fas fa-comment-dots ml-1"></i> Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:
                            </span>
                            ${order.reply ? `
                                <button onclick="copyReply('${order.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700">
                                    <i class="far fa-copy ml-1"></i> Ù†Ø³Ø®
                                </button>
                            ` : ''}
                        </div>
                        <div class="reply-content">
                            ${order.reply || 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„...'}
                        </div>
                    </div>
                    
                    ${adminNotesDisplay}
                    
                    ${actionsHTML}
                </div>
            `;
        }

        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ HTML Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠ
        function generateStatusTimelineHTML(statusTimeline) {
            let html = '<div class="order-status-timeline">';
            
            // Ø­Ø§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            if (statusTimeline.pending) {
                html += `
                    <div class="status-item">
                        <div class="status-dot pending"></div>
                        <div>
                            <div class="status-label">${statusTimeline.pending.status}</div>
                            <div class="status-time">${statusTimeline.pending.time}</div>
                        </div>
                    </div>
                    <div class="status-separator"></div>
                `;
            }
            
            // Ø­Ø§Ù„Ø© Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
            if (statusTimeline.viewed) {
                html += `
                    <div class="status-item">
                        <div class="status-dot viewed"></div>
                        <div>
                            <div class="status-label">${statusTimeline.viewed.status}</div>
                            <div class="status-time">${statusTimeline.viewed.time}</div>
                        </div>
                    </div>
                    <div class="status-separator"></div>
                `;
            }
            
            // Ø­Ø§Ù„Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
            if (statusTimeline.completed) {
                html += `
                    <div class="status-item">
                        <div class="status-dot completed"></div>
                        <div>
                            <div class="status-label">${statusTimeline.completed.status}</div>
                            <div class="status-time">${statusTimeline.completed.time}</div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        function generateDefaultTimelineHTML(order) {
            let html = '<div class="order-status-timeline">';
            
            // Ø­Ø§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
            html += `
                <div class="status-item">
                    <div class="status-dot pending"></div>
                    <div>
                        <div class="status-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
                        <div class="status-time">${order.timestamp}</div>
                    </div>
                </div>
                <div class="status-separator"></div>
            `;
            
            // Ø­Ø§Ù„Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„Ø§Ù‹)
            if (order.status === 'Ù…ÙƒØªÙ…Ù„') {
                const completionTime = order.replyTimestamp || order.timestamp;
                html += `
                    <div class="status-item">
                        <div class="status-dot completed"></div>
                        <div>
                            <div class="status-label">Ù…ÙƒØªÙ…Ù„</div>
                            <div class="status-time">${completionTime}</div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        function updateDuplicateCounter() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
            let visibleDuplicateCount = 0;
            if (currentUser.role === 'admin') {
                if (currentFocusedUser) {
                    // Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙŠØ±Ù‰ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
                    visibleDuplicateCount = allOrders.filter(o => 
                        o.isDuplicate && o.sender === currentFocusedUser
                    ).length;
                } else {
                    // Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙŠØ±Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
                    visibleDuplicateCount = duplicateCount;
                }
            } else {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ù‰ ÙÙ‚Ø· Ø·Ù„Ø¨Ø§ØªÙ‡ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
                visibleDuplicateCount = allOrders.filter(o => 
                    o.isDuplicate && o.sender === currentUser.name
                ).length;
            }
            
            if (visibleDuplicateCount > 0) {
                document.getElementById('duplicate-count').classList.remove('hidden');
                document.getElementById('duplicate-number').innerText = visibleDuplicateCount;
            } else {
                document.getElementById('duplicate-count').classList.add('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¯Ø§Ø¡
        function setupSearchAndFilter() {
            const searchBox = document.getElementById('search-box');
            const filterStatus = document.getElementById('filter-status');
            
            // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ ØªØ£Ø®ÙŠØ± debounce Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²Ø§Ø¦Ø¯
            searchBox.addEventListener('input', () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    displayOrders(allOrders);
                }, window.innerWidth < 768 ? 300 : 150); // ÙˆÙ‚Øª Ø£Ø·ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
            });
            
            // ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙ„ØªØ±Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø¯Ø§Ø¡
            filterStatus.addEventListener('change', () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    displayOrders(allOrders);
                }, window.innerWidth < 768 ? 100 : 50); // ÙˆÙ‚Øª Ø£Ù‚Ù„ Ù„Ù„ÙÙ„ØªØ±Ø©
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats(stats) {
            if (currentUser.role === 'admin') {
                document.getElementById('stat-total').innerText = stats.total;
                document.getElementById('stat-pending').innerText = stats.pending;
                document.getElementById('stat-done').innerText = stats.done;
                document.getElementById('stat-duplicate').innerText = stats.duplicate;
            }
        }

        // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ø±Ø¯
        window.copyReply = function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.reply) return;
            
            navigator.clipboard.writeText(order.reply)
                .then(() => {
                    showPushNotification('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                })
                .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®"));
        };

        // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
        window.openReplyModal = function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            selectedOrderId = orderId;
            
            document.getElementById('modal-title').innerText = 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨';
            
            let imageSection = '';
            if (order.imageData) {
                imageSection = `
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©:</p>
                        <img src="${order.imageData}" 
                             alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨" 
                             class="w-full max-w-xs mx-auto rounded-lg cursor-pointer"
                             onclick="openImageModal('${order.imageData}')"
                             title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                        ${order.imageName ? `<p class="text-xs text-gray-500 text-center mt-2">${order.imageName}</p>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ù… Ù…Ù†:</p>
                        <p class="font-bold text-lg">${order.sender}</p>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div>
                                <p class="text-sm text-gray-600">ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨:</p>
                                <p class="font-medium">${order.subjectName || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</p>
                                <p class="font-medium">${order.birth || '-'}</p>
                            </div>
                        </div>
                        ${imageSection}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-edit ml-1"></i> Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ *
                        </label>
                        <textarea 
                            id="admin-reply-text" 
                            rows="4" 
                            class="w-full p-3"
                            placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù‡Ù†Ø§..."
                            required
                        >${order.reply || ''}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sticky-note ml-1"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                            <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                        </label>
                        <textarea 
                            id="admin-notes-text" 
                            rows="3" 
                            class="w-full p-3"
                            placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ø§ØµØ©..."
                        >${order.adminNotes || ''}</textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-reply').classList.remove('hidden');
            document.getElementById('admin-reply-text').focus();
        };

        // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ
        window.saveReply = function() {
            const reply = document.getElementById('admin-reply-text').value.trim();
            const adminNotes = document.getElementById('admin-notes-text').value.trim();
            
            if (!reply) {
                alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            
            const order = allOrders.find(o => o.id === selectedOrderId);
            const currentTime = new Date().toLocaleString('ar-EG');
            const currentTimestamp = Date.now();
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            const statusTimeline = order.statusTimeline || {};
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
            if (!statusTimeline.viewed) {
                statusTimeline.viewed = {
                    status: "ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
                    time: currentTime,
                    timestamp: currentTimestamp
                };
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
            statusTimeline.completed = {
                status: "Ù…ÙƒØªÙ…Ù„",
                time: currentTime,
                timestamp: currentTimestamp
            };
            
            const updates = {
                reply: reply,
                status: "Ù…ÙƒØªÙ…Ù„",
                replyTimestamp: currentTime,
                statusTimeline: statusTimeline
            };
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¥Ù† ÙˆØ¬Ø¯Øª
            if (adminNotes) {
                updates.adminNotes = adminNotes;
            }
            
            update(ref(db, 'orders/' + selectedOrderId), updates)
            .then(() => {
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† Ø§Ù„Ø±Ø¯
                sendNotification('order_replied', order.sender, 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', order.subjectName);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                sendNotification('order_completed', order.sender, 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', order.subjectName);
                
                showPushNotification('ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨', `ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ ${order.subjectName}`, 'success');
                closeModal();
                fetchOrders();
            })
            .catch(error => {
                showPushNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', error.message, 'warning');
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
            });
        };

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
        window.deleteOrder = function(orderId) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
            
            remove(ref(db, 'orders/' + orderId))
                .then(() => {
                    showPushNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    fetchOrders();
                })
                .catch(error => {
                    showPushNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù', error.message, 'warning');
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
                });
        };

        // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        window.closeModal = function() {
            document.getElementById('modal-reply').classList.add('hidden');
            selectedOrderId = '';
        };

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.logout = function() {
            localStorage.clear();
            showPushNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'info');
            setTimeout(() => {
                location.reload();
            }, 1000);
        };

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const session = localStorage.getItem('user_session');
        if (session) {
            const sessionData = JSON.parse(session);
            currentUser = { name: sessionData.name, role: sessionData.role };
            showDashboard();
        }

        // ØªÙ‚ÙŠÙŠØ¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        document.getElementById('login-pass').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notifications-dropdown');
            const notificationsBtn = document.querySelector('.notifications-btn');
            
            if (dropdown && !dropdown.classList.contains('hidden') && 
                !dropdown.contains(event.target) && 
                !notificationsBtn.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.getElementById('image-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeImageModal();
            }
        });

        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù…ÙØªØ§Ø­ ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && !document.getElementById('image-modal').classList.contains('hidden')) {
                closeImageModal();
            }
        });

        // Ø¯Ø¹Ù… Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ø§Ù„ØµÙˆØ±
        const dropArea = document.getElementById('no-image-section');
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#3b82f6';
            dropArea.style.background = '#f0f9ff';
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#e2e8f0';
            dropArea.style.background = '#f8fafc';
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#e2e8f0';
            dropArea.style.background = '#f8fafc';
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.match('image.*')) {
                // Ù…Ø­Ø§ÙƒØ§Ø© ØªØºÙŠÙŠØ± input file
                const input = document.getElementById('image-upload');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                
                // ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                previewImage({ target: input });
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·');
            }
        });

        // ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ÙŠØ©
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/firebase-messaging-sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ÙŠØ©
        function initializePushNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                    }
                });
            }
        }

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        initializePushNotifications();
    </script>
</body>
</html>