<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª - ÙƒØ´Ù Ø§Ù„ØªÙƒØ±Ø§Ø±</title>
    
    <!-- Preconnect Ù„Ù„ØªØ­Ø³ÙŠÙ† -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { 
            font-family: 'Cairo', sans-serif; 
            box-sizing: border-box;
        }
        
        body { 
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ */
        .order-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-right: 6px solid #3b82f6;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .order-card.duplicate {
            border-right: 6px solid #ef4444;
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
            animation: pulseWarning 2s infinite;
        }
        
        @keyframes pulseWarning {
            0%, 100% { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1); }
            50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2); }
        }
        
        /* Ø´Ø§Ø±Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± */
        .duplicate-badge {
            position: absolute;
            top: -8px;
            left: 15px;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .alert-modal {
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            animation: alertSlideIn 0.4s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            border-top: 8px solid #ef4444;
        }
        
        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        input, select, textarea {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯ */
        .reply-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            color: #1e40af;
            font-weight: 700;
            background: #f8fafc;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        /* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ */
        .admin-notes-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            color: #7c3aed;
            font-weight: 700;
            background: #f5f3ff;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #ddd6fe;
        }
        
        /* Ø§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }
        
        /* Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notifications-btn {
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø© */
        .timeline {
            position: relative;
            padding-right: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            right: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e2e8f0;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 15px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            right: -30px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        
        .timeline-item.received::before { background: #10b981; }
        .timeline-item.viewed::before { background: #f59e0b; }
        .timeline-item.replied::before { background: #8b5cf6; }
        .timeline-item.completed::before { background: #06b6d4; }
        
        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
        @media (max-width: 640px) {
            .modal-content {
                padding: 20px;
                border-radius: 20px;
            }
            
            .alert-modal {
                padding: 20px;
                border-radius: 20px;
            }
            
            /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù„Ù…Ø³ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© */
            .btn, input, select, textarea {
                min-height: 48px;
            }
            
            .order-card {
                padding: 16px;
                margin-bottom: 12px;
            }
        }
        
        /* Loader Ø¹Ø§Ù… */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            padding: 15px;
        }
        
        .page-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: white;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .page-btn:hover:not(.active) {
            background: #f1f5f9;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Infinite scroll indicator */
        .infinite-scroll-indicator {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }
        
        /* Info rows */
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .info-row .label {
            color: #64748b;
            font-size: 14px;
        }
        
        .info-row .value {
            font-weight: 600;
            color: #1e293b;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-3xl p-10 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full mb-6 shadow-lg">
                    <i class="fas fa-shield-check text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-black text-gray-800 mb-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
                <p class="text-gray-600 text-sm">Ù…Ø¹ Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key ml-1"></i> Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="login-pass" 
                            class="w-full p-4 pr-12 border-2 border-gray-200 rounded-2xl text-center text-xl tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                            placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„"
                            maxlength="4"
                        >
                        <i class="fas fa-key absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <button 
                    onclick="handleLogin()" 
                    class="w-full btn btn-primary py-4 rounded-2xl text-lg"
                >
                    <i class="fas fa-sign-in-alt ml-2"></i> Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
                </button>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-app" class="hidden min-h-screen">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <header class="glass-card shadow-sm mb-6 mx-4 mt-4 rounded-2xl sticky top-4 z-40">
            <div class="flex justify-between items-center p-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-search-plus text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 id="user-display-name" class="font-bold text-lg text-gray-800"></h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="user-role-badge" class="badge"></span>
                            <button onclick="refreshOrders()" class="text-xs text-gray-500 hover:text-blue-600">
                                <i class="fas fa-sync-alt ml-1"></i> ØªØ­Ø¯ÙŠØ«
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                    <button 
                        onclick="toggleNotifications()" 
                        class="notifications-btn relative p-3 text-gray-600 hover:text-blue-600 transition-colors"
                    >
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                    </button>
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                    <div id="notifications-dropdown" class="hidden absolute top-20 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 max-h-96 overflow-y-auto">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                                <button onclick="markAllNotificationsAsRead()" class="text-sm text-blue-600 hover:text-blue-800">
                                    ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
                                </button>
                            </div>
                        </div>
                        <div id="notifications-list" class="p-2">
                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </div>
                    </div>
                    
                    <button 
                        onclick="logout()" 
                        class="btn btn-danger px-6"
                    >
                        <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </header>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
        <main class="max-w-4xl mx-auto px-4 pb-24">
            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
            <div id="admin-stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                            <h3 id="stat-total" class="text-3xl font-bold text-gray-800">0</h3>
                        </div>
                        <i class="fas fa-file-alt text-blue-500 text-2xl"></i>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                            <h3 id="stat-pending" class="text-3xl font-bold text-amber-600">0</h3>
                        </div>
                        <i class="fas fa-clock text-amber-500 text-2xl"></i>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p>
                            <h3 id="stat-done" class="text-3xl font-bold text-emerald-600">0</h3>
                        </div>
                        <i class="fas fa-check-circle text-emerald-500 text-2xl"></i>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">Ù…ÙƒØ±Ø±Ø©</p>
                            <h3 id="stat-duplicate" class="text-3xl font-bold text-red-600">0</h3>
                        </div>
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
            <div id="user-section" class="hidden mb-8">
                <div class="glass-card rounded-2xl p-6 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                            <i class="fas fa-plus text-white text-lg"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                    </div>
                    
                    <form id="request-form" class="space-y-6">
                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø¬Ù†Ø³ ÙˆØ§Ù„Ø§Ø³Ù… -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user ml-1 text-gray-400"></i> Ø§Ù„Ø¬Ù†Ø³ *
                                </label>
                                <select id="gender" required class="w-full">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
                                    <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                                    <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user-tag ml-1 text-gray-400"></i> Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ *
                                </label>
                                <input 
                                    type="text" 
                                    id="subject-name" 
                                    required 
                                    placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"
                                >
                            </div>
                        </div>

                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙˆØ§Ù„Ø§Ù†ØªØ³Ø§Ø¨ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-birthday-cake ml-1 text-gray-400"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ *
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-day" 
                                            required 
                                            min="1" 
                                            max="31"
                                            placeholder="ÙŠÙˆÙ…"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-month" 
                                            required 
                                            min="1" 
                                            max="12"
                                            placeholder="Ø´Ù‡Ø±"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-year" 
                                            required 
                                            min="1900" 
                                            max="2026"
                                            placeholder="Ø³Ù†Ø©"
                                            class="text-center"
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt ml-1 text-gray-400"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨
                                    <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-day" 
                                            min="1" 
                                            max="31"
                                            placeholder="ÙŠÙˆÙ…"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-month" 
                                            min="1" 
                                            max="12"
                                            placeholder="Ø´Ù‡Ø±"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-year" 
                                            min="1900" 
                                            max="2026"
                                            placeholder="Ø³Ù†Ø©"
                                            class="text-center"
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„ÙØ¦Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Ø§Ù„ÙØ¦Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-layer-group ml-1 text-gray-400"></i> Ø§Ù„ÙØ¦Ø©
                                    <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                </label>
                                <select id="category" class="w-full">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
                                    <option value="1">Ø§Ù„ÙØ¦Ø© 1</option>
                                    <option value="2">Ø§Ù„ÙØ¦Ø© 2</option>
                                    <option value="3">Ø§Ù„ÙØ¦Ø© 3</option>
                                    <option value="4">Ø§Ù„ÙØ¦Ø© 4</option>
                                    <option value="5">Ø§Ù„ÙØ¦Ø© 5</option>
                                    <option value="6">Ø§Ù„ÙØ¦Ø© 6</option>
                                    <option value="7">Ø§Ù„ÙØ¦Ø© 7</option>
                                    <option value="8">Ø§Ù„ÙØ¦Ø© 8</option>
                                    <option value="9">Ø§Ù„ÙØ¦Ø© 9</option>
                                    <option value="10">Ø§Ù„ÙØ¦Ø© 10</option>
                                    <option value="11">Ø§Ù„ÙØ¦Ø© 11</option>
                                    <option value="12">Ø§Ù„ÙØ¦Ø© 12</option>
                                    <option value="13">Ø§Ù„ÙØ¦Ø© 13</option>
                                    <option value="14">Ø§Ù„ÙØ¦Ø© 14</option>
                                    <option value="15">Ø§Ù„ÙØ¦Ø© 15</option>
                                </select>
                            </div>

                            <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-sticky-note ml-1 text-gray-400"></i> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                    <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                </label>
                                <textarea 
                                    id="notes" 
                                    rows="3" 
                                    placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
                        <div class="pt-4">
                            <button 
                                type="submit" 
                                id="submit-btn" 
                                class="w-full btn btn-primary py-4 rounded-2xl text-lg"
                            >
                                <i class="fas fa-search-check ml-2"></i> ÙØ­Øµ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© -->
            <div class="glass-card rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                        <i class="fas fa-history text-blue-600"></i>
                        Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                        <span id="duplicate-count" class="hidden bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">
                            <i class="fas fa-exclamation-triangle ml-1"></i>
                            <span id="duplicate-number">0</span> Ù…ÙƒØ±Ø±Ø©
                        </span>
                    </h2>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full md:w-auto">
                        <div class="relative w-full sm:w-64">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input 
                                type="text" 
                                id="search-box" 
                                class="w-full p-3 pr-10 rounded-xl"
                                placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."
                            >
                        </div>
                        
                        <select 
                            id="filter-status" 
                            class="w-full sm:w-auto p-3 rounded-xl"
                        >
                            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                            <option value="Ù…ÙƒØªÙ…Ù„">Ù…ÙƒØªÙ…Ù„Ø©</option>
                            <option value="duplicate">Ù…ÙƒØ±Ø±Ø© ÙÙ‚Ø·</option>
                        </select>
                    </div>
                </div>

                <!-- Ø­Ø§ÙˆÙŠØ© Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
                <div id="orders-cards-container">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div id="pagination-container" class="hidden pagination">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                
                <!-- Infinite scroll indicator -->
                <div id="infinite-scroll-indicator" class="infinite-scroll-indicator hidden">
                    <i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i>
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯...
                </div>
            </div>
        </main>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div id="modal-reply" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
                <button 
                    onclick="closeModal()" 
                    class="text-gray-400 hover:text-gray-600 text-2xl"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-content" class="space-y-6">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            
            <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
                <button 
                    onclick="closeModal()" 
                    class="flex-1 btn btn-secondary py-3"
                >
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button 
                    id="modal-save-btn" 
                    onclick="saveReply()" 
                    class="flex-1 btn btn-primary py-3"
                >
                    <i class="fas fa-check ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙƒØ±Ø§Ø± -->
    <div id="duplicate-alert" class="alert-overlay hidden">
        <div class="alert-modal">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-14 h-14 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-black text-gray-800">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø·Ù„Ø¨ Ù…ÙƒØ±Ø±</h3>
                    <p class="text-gray-600 text-sm">ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø·Ù„Ø¨ Ù…Ø³Ø¨Ù‚ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!</p>
                </div>
            </div>
            
            <div class="space-y-4" id="duplicate-alert-content">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§ -->
            </div>
            
            <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
                <button 
                    onclick="closeDuplicateAlert()" 
                    class="flex-1 btn btn-secondary py-3"
                >
                    <i class="fas fa-times ml-2"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
                <button 
                    id="force-submit-btn" 
                    onclick="forceSubmitOrder()" 
                    class="flex-1 btn btn-danger py-3"
                >
                    <i class="fas fa-exclamation-triangle ml-2"></i> Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±
                </button>
            </div>
        </div>
    </div>

    <!-- Loader Ø¹Ø§Ù… -->
    <div id="global-loader" class="hidden">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center shadow-2xl">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="font-medium text-gray-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            update, 
            remove,
            query,
            orderByChild,
            limitToLast,
            limitToFirst,
            startAt,
            endAt
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOzouJz7ROysGrL2KoS6GPU046Mfq5EKg",
            authDomain: "damin-62c82.firebaseapp.com",
            databaseURL: "https://damin-62c82-default-rtdb.firebaseio.com",
            projectId: "damin-62c82",
            storageBucket: "damin-62c82.firebasestorage.app",
            messagingSenderId: "787751266614",
            appId: "1:787751266614:web:4045deaf010156db4eab97"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const usersMap = {
            "0780": { name: "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…", role: "admin" },
            "2004": { name: "Ù…Ù‡Ø¯ÙŠ Ø£Ø­Ù…Ø¯", role: "user" },
            "1982": { name: "Ù…Ù‡Ù†Ø¯ Ø¹Ù„ÙŠ (Ø£Ø¨Ùˆ Ø³ÙŠÙ)", role: "user" },
            "2001": { name: "Ù…Ù‡Ø¯ÙŠ (Ø¯. Ø¥ÙŠÙ‡Ø§Ø¨)", role: "user" },
            "1996": { name: "Ø­ÙŠØ¯Ø± Ø§Ù„ÙƒØ±Ø¹Ø§ÙˆÙŠ", role: "user" },
            "1234": { name: "Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ", role: "user" },
            "2026": { name: "ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ", role: "user" }
        };

        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const appState = {
            currentUser: null,
            allOrders: [],
            filteredOrders: [],
            displayedOrders: [],
            selectedOrderId: '',
            currentNewOrderData: null,
            duplicateOrders: [],
            duplicateCount: 0,
            notifications: [],
            filters: {
                search: '',
                status: '',
                page: 1
            },
            pagination: {
                page: 1,
                totalPages: 1,
                ordersPerPage: 20,
                totalOrders: 0,
                isLoadingMore: false,
                hasMore: true
            },
            performanceMetrics: {
                duplicateCheckTime: 0,
                searchTime: 0,
                renderTime: 0
            }
        };

        // ÙƒØ§Ø¦Ù† Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
        const seenCombinations = new Map();

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.handleLogin = function() {
            const pass = document.getElementById('login-pass').value.trim();
            if (usersMap[pass]) {
                appState.currentUser = usersMap[pass];
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
                const sessionData = {
                    ...appState.currentUser,
                    loginTime: new Date().toISOString()
                };
                localStorage.setItem('user_session', JSON.stringify(sessionData));
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø¨Ø£Ø©
                loadCachedData();
                
                showDashboard();
                fetchNotifications();
                
                // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            } else {
                alert("Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!");
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø¨Ø£Ø©
        function loadCachedData() {
            const cached = localStorage.getItem('cached_orders');
            if (cached) {
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < 5 * 60 * 1000) { // 5 Ø¯Ù‚Ø§Ø¦Ù‚
                    appState.allOrders = data;
                    appState.pagination.totalOrders = data.length;
                    updateDisplayedOrders();
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø¨Ø£Ø©
        function cacheOrders(orders) {
            try {
                localStorage.setItem('cached_orders', 
                    JSON.stringify({
                        data: orders,
                        timestamp: Date.now()
                    })
                );
            } catch (e) {
                console.warn('Cache failed:', e);
            }
        }

        // Ø¯Ø§Ù„Ø© Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡
        function measurePerformance(name, operation) {
            const start = performance.now();
            const result = operation();
            const end = performance.now();
            appState.performanceMetrics[name] = (end - start).toFixed(2);
            console.log(`${name}: ${appState.performanceMetrics[name]}ms`);
            return result;
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('user-display-name').innerText = appState.currentUser.name;
            
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.innerText = appState.currentUser.role === 'admin' ? "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…" : "Ù…Ø³ØªØ®Ø¯Ù…";
            roleBadge.className = appState.currentUser.role === 'admin' 
                ? 'badge badge-success' 
                : 'badge badge-info';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            if (appState.currentUser.role === 'admin') {
                document.getElementById('admin-stats').classList.remove('hidden');
                document.getElementById('user-section').classList.add('hidden');
            } else {
                document.getElementById('admin-stats').classList.add('hidden');
                document.getElementById('user-section').classList.remove('hidden');
            }
            
            fetchOrders();
            setupSearchAndFilter();
            setupInfiniteScroll();
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        window.refreshOrders = function() {
            showLoader(true);
            fetchOrders();
            fetchNotifications();
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø±
        function showLoader(show) {
            const loader = document.getElementById('global-loader');
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function fetchNotifications() {
            if (!appState.currentUser) return;
            
            onValue(ref(db, 'notifications'), (snapshot) => {
                const data = snapshot.val();
                appState.notifications = [];
                
                if (data) {
                    for (let id in data) {
                        const notif = { id, ...data[id] };
                        
                        if (appState.currentUser.role === 'admin' || 
                            (notif.targetUser === appState.currentUser.name && !notif.read)) {
                            appState.notifications.push(notif);
                        }
                    }
                }
                
                updateNotificationsUI();
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function updateNotificationsUI() {
            const unreadCount = appState.notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');
            
            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            } else {
                badge.classList.add('hidden');
            }
            
            showBrowserNotifications();
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
        function showBrowserNotifications() {
            if (!("Notification" in window)) return;
            
            const newNotifications = appState.notifications.filter(n => 
                !n.read && 
                (n.type === 'new_order' || n.type === 'order_replied' || n.type === 'order_completed')
            );
            
            newNotifications.forEach(notif => {
                if (Notification.permission === "granted") {
                    let title, body;
                    
                    switch(notif.type) {
                        case 'new_order':
                            title = 'ğŸ“‹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
                            body = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${notif.sender}`;
                            break;
                        case 'order_replied':
                            title = 'ğŸ’¬ Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ';
                            body = `ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„`;
                            break;
                        case 'order_completed':
                            title = 'âœ… Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
                            body = `ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­`;
                            break;
                    }
                    
                    new Notification(title, {
                        body: body,
                        icon: '/icon.png',
                        tag: notif.id
                    });
                }
                
                if (!notif.read) {
                    update(ref(db, 'notifications/' + notif.id), { read: true });
                }
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        window.toggleNotifications = function() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                displayNotificationsList();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function displayNotificationsList() {
            const listContainer = document.getElementById('notifications-list');
            
            if (appState.notifications.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-bell-slash text-3xl mb-3"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
                    </div>
                `;
                return;
            }
            
            const sortedNotifications = [...appState.notifications].sort((a, b) => b.timestamp - a.timestamp);
            
            let listHTML = '';
            sortedNotifications.forEach(notif => {
                const timeAgo = getTimeAgo(notif.timestamp);
                const isReadClass = notif.read ? 'opacity-70' : 'bg-blue-50';
                
                let icon, color, text;
                
                switch(notif.type) {
                    case 'new_order':
                        icon = 'fa-file-alt';
                        color = 'text-blue-600';
                        text = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${notif.sender}`;
                        break;
                    case 'order_replied':
                        icon = 'fa-reply';
                        color = 'text-green-600';
                        text = `Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ`;
                        break;
                    case 'order_completed':
                        icon = 'fa-check-circle';
                        color = 'text-emerald-600';
                        text = `ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ`;
                        break;
                    case 'duplicate_warning':
                        icon = 'fa-exclamation-triangle';
                        color = 'text-red-600';
                        text = `ØªÙ†Ø¨ÙŠÙ‡: Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± Ù…Ù† ${notif.sender}`;
                        break;
                    default:
                        icon = 'fa-bell';
                        color = 'text-gray-600';
                        text = notif.message || 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯';
                }
                
                listHTML += `
                    <div class="notification-item p-3 border-b border-gray-100 hover:bg-gray-50 ${isReadClass}" onclick="markNotificationAsRead('${notif.id}')">
                        <div class="flex items-start gap-3">
                            <div class="${color}">
                                <i class="fas ${icon} text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${text}</p>
                                ${notif.orderSubject ? `
                                    <p class="text-xs text-gray-600 mt-1">Ø§Ù„Ø·Ù„Ø¨: ${notif.orderSubject}</p>
                                ` : ''}
                                <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                            </div>
                            ${!notif.read ? `
                                <span class="w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = listHTML;
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
            if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
            return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡
        window.markNotificationAsRead = function(notificationId) {
            update(ref(db, 'notifications/' + notificationId), { read: true })
                .then(() => {
                    fetchNotifications();
                });
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
        window.markAllNotificationsAsRead = function() {
            appState.notifications.forEach(notif => {
                if (!notif.read) {
                    update(ref(db, 'notifications/' + notif.id), { read: true });
                }
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        function sendNotification(type, targetUser, sender, orderSubject = '', orderId = '') {
            const notificationData = {
                type: type,
                targetUser: targetUser,
                sender: sender,
                orderSubject: orderSubject,
                orderId: orderId,
                timestamp: Date.now(),
                read: false
            };
            
            push(ref(db, 'notifications'), notificationData);
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ù„Ù„Ø·Ù„Ø¨
        function generateOrderKey(order) {
            return `${order.gender}_${order.birth}_${order.joinDate || ''}_${order.category || ''}`;
        }

        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        function checkForDuplicatesEfficiently(newOrder) {
            return measurePerformance('duplicateCheck', () => {
                const key = generateOrderKey(newOrder);
                const now = Date.now();
                
                if (seenCombinations.has(key)) {
                    const existingOrders = seenCombinations.get(key);
                    return existingOrders.filter(order => 
                        Math.abs(order.timestampOrder - now) > 24 * 60 * 60 * 1000
                    );
                }
                return [];
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
        document.getElementById('request-form').onsubmit = async (e) => {
            e.preventDefault();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
            const gender = sanitizeInput(document.getElementById('gender').value);
            const subjectName = sanitizeInput(document.getElementById('subject-name').value.trim());
            const category = sanitizeInput(document.getElementById('category').value);
            const bDay = document.getElementById('b-day').value;
            const bMonth = document.getElementById('b-month').value;
            const bYear = document.getElementById('b-year').value;
            const jDay = document.getElementById('j-day').value;
            const jMonth = document.getElementById('j-month').value;
            const jYear = document.getElementById('j-year').value;
            const notes = sanitizeInput(document.getElementById('notes').value.trim());
            
            if (!gender || !subjectName || !bDay || !bMonth || !bYear) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (*)");
                return;
            }
            
            const birthDate = `${bDay}/${bMonth}/${bYear}`;
            let joinDate = '';
            if (jDay && jMonth && jYear) {
                joinDate = `${jDay}/${jMonth}/${jYear}`;
            }
            
            const newOrderData = {
                sender: appState.currentUser.name,
                gender: gender,
                subjectName: subjectName,
                category: category || '',
                birth: birthDate,
                joinDate: joinDate,
                notes: notes,
                status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                reply: "",
                adminNotes: "",
                statusHistory: [{
                    status: "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
                    timestamp: Date.now(),
                    user: appState.currentUser.name
                }],
                timestamp: new Date().toLocaleString('ar-EG'),
                timestampOrder: Date.now(),
                senderId: appState.currentUser.name.replace(/\s+/g, '_') + '_' + Date.now()
            };
            
            appState.currentNewOrderData = newOrderData;
            
            // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨ÙƒÙØ§Ø¡Ø©
            const duplicates = checkForDuplicatesEfficiently(newOrderData);
            
            if (duplicates.length > 0) {
                appState.duplicateOrders = duplicates;
                showDuplicateAlert(duplicates, newOrderData);
            } else {
                submitOrder(newOrderData);
            }
        };

        // Ø¯Ø§Ù„Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        function sanitizeInput(input) {
            if (!input) return '';
            return input
                .replace(/[<>]/g, '')
                .trim()
                .substring(0, 1000);
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙƒØ±Ø§Ø±
        function showDuplicateAlert(duplicates, newOrder) {
            let alertContent = `
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                    <p class="font-bold text-red-700 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„Ø¬Ù†Ø³:</span>
                            <span class="font-bold">${newOrder.gender}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span>
                            <span class="font-bold">${newOrder.birth}</span>
                        </div>
                        ${newOrder.joinDate ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨:</span>
                            <span class="font-bold">${newOrder.joinDate}</span>
                        </div>
                        ` : ''}
                        ${newOrder.category ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„ÙØ¦Ø©:</span>
                            <span class="font-bold">ÙØ¦Ø© ${newOrder.category}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <p class="font-bold text-amber-700 mb-3">
                        <i class="fas fa-exclamation-circle ml-1"></i>
                        ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${duplicates.length} Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± Ø³Ø§Ø¨Ù‚Ø§Ù‹:
                    </p>
            `;
            
            duplicates.forEach((dup, index) => {
                const duplicateDate = new Date(dup.timestampOrder).toLocaleString('ar-EG');
                alertContent += `
                    <div class="mb-3 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-gray-800">${index + 1}. ${dup.subjectName}</span>
                            <span class="text-xs text-gray-500">${duplicateDate}</span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex justify-between">
                                <span>Ø§Ù„Ù…Ø±Ø³Ù„:</span>
                                <span class="font-bold">${dup.sender}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</span>
                                <span class="font-bold ${dup.status === 'Ù…ÙƒØªÙ…Ù„' ? 'text-green-600' : 'text-amber-600'}">${dup.status}</span>
                            </div>
                            ${dup.reply ? `
                            <div class="mt-2">
                                <span class="text-gray-500">Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span>
                                <p class="text-gray-700 text-xs mt-1 bg-gray-100 p-2 rounded">${dup.reply.substring(0, 100)}${dup.reply.length > 100 ? '...' : ''}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            alertContent += `
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mt-4">
                    <p class="text-blue-700 text-sm flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        <span>Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙŠØ¸Ù‡Ø± Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±</span>
                    </p>
                </div>
            `;
            
            document.getElementById('duplicate-alert-content').innerHTML = alertContent;
            document.getElementById('duplicate-alert').classList.remove('hidden');
            
            if (appState.currentUser.role !== 'admin') {
                sendDuplicateNotificationToAdmins(newOrder, duplicates);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙƒØ±Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
        function sendDuplicateNotificationToAdmins(newOrder, duplicates) {
            sendNotification('duplicate_warning', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', appState.currentUser.name, newOrder.subjectName);
            
            const notificationData = {
                type: 'duplicate_warning',
                newOrder: newOrder,
                duplicateCount: duplicates.length,
                timestamp: Date.now(),
                notifiedAdmins: true
            };
            
            try {
                push(ref(db, 'notifications'), notificationData);
            } catch (error) {
                console.log("ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªÙƒØ±Ø§Ø±ØŒ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†:", error);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø³Ø±ÙŠ (Ù…Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±)
        window.forceSubmitOrder = async function() {
            if (!appState.currentNewOrderData) return;
            
            const btn = document.getElementById('force-submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            appState.currentNewOrderData.isDuplicate = true;
            appState.currentNewOrderData.duplicateWarning = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± ${appState.duplicateOrders.length} Ù…Ø±Ø© Ø³Ø§Ø¨Ù‚Ø©`;
            appState.currentNewOrderData.duplicateReferences = appState.duplicateOrders.map(d => d.id);
            
            try {
                await push(ref(db, 'orders'), appState.currentNewOrderData);
                
                sendNotification('new_order', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', appState.currentUser.name, appState.currentNewOrderData.subjectName);
                
                closeDuplicateAlert();
                
                alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±\nØªÙ… Ø§ÙƒØªØ´Ø§Ù ${appState.duplicateOrders.length} Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± Ø³Ø§Ø¨Ù‚Ø§Ù‹`);
                
                document.getElementById('request-form').reset();
                
                fetchOrders();
            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle ml-2"></i> Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±';
            }
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        async function submitOrder(orderData) {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            try {
                await push(ref(db, 'orders'), orderData);
                
                sendNotification('new_order', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', appState.currentUser.name, orderData.subjectName);
                
                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
                document.getElementById('request-form').reset();
                fetchOrders();
            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search-check ml-2"></i> ÙØ­Øµ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
        window.closeDuplicateAlert = function() {
            document.getElementById('duplicate-alert').classList.add('hidden');
            appState.currentNewOrderData = null;
            appState.duplicateOrders = [];
        };

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Pagination
        function fetchOrders() {
            showLoader(true);
            
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                appState.allOrders = [];
                appState.duplicateCount = 0;
                let stats = { total: 0, pending: 0, done: 0, duplicate: 0 };
                
                seenCombinations.clear();
                
                if (data) {
                    for (let id in data) {
                        const order = { id, ...data[id] };
                        appState.allOrders.push(order);
                        stats.total++;
                        if (order.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") stats.pending++; else stats.done++;
                        
                        // ØªØ­Ø¯ÙŠØ« Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
                        const key = generateOrderKey(order);
                        if (!seenCombinations.has(key)) {
                            seenCombinations.set(key, []);
                        }
                        seenCombinations.get(key).push(order);
                        
                        if (order.isDuplicate) {
                            appState.duplicateCount++;
                        }
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙƒØ±Ø§Ø±
                    detectExistingDuplicates();
                    
                    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                    appState.allOrders.sort((a, b) => (b.timestampOrder || 0) - (a.timestampOrder || 0));
                    
                    // Ø­ÙØ¸ Ù…Ø®Ø¨Ø£
                    cacheOrders(appState.allOrders);
                }
                
                stats.duplicate = appState.duplicateCount;
                appState.pagination.totalOrders = appState.allOrders.length;
                appState.pagination.totalPages = Math.ceil(appState.allOrders.length / appState.pagination.ordersPerPage);
                
                updateDisplayedOrders();
                updateStats(stats);
                showLoader(false);
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ù…Ø¹ Pagination
        function updateDisplayedOrders() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const filter = document.getElementById('filter-status').value;
            
            // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            appState.filteredOrders = appState.allOrders.filter(o => {
                if (appState.currentUser.role !== 'admin' && o.sender !== appState.currentUser.name) return false;
                if (searchTerm && !o.subjectName.toLowerCase().includes(searchTerm)) return false;
                if (filter === 'duplicate' && !o.isDuplicate && !o.hasDuplicates) return false;
                if (filter && filter !== 'duplicate' && o.status !== filter) return false;
                return true;
            });
            
            appState.pagination.totalPages = Math.ceil(appState.filteredOrders.length / appState.pagination.ordersPerPage);
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const startIndex = (appState.pagination.page - 1) * appState.pagination.ordersPerPage;
            const endIndex = startIndex + appState.pagination.ordersPerPage;
            
            appState.displayedOrders = appState.filteredOrders.slice(startIndex, endIndex);
            appState.pagination.hasMore = endIndex < appState.filteredOrders.length;
            
            displayOrders(appState.displayedOrders);
            updatePagination();
            updateDuplicateCounter();
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        function detectExistingDuplicates() {
            const duplicatesMap = new Map();
            
            appState.allOrders.forEach(order => {
                const key = `${order.gender}_${order.birth}_${order.joinDate || 'nojoin'}_${order.category || 'nocat'}`;
                
                if (!duplicatesMap.has(key)) {
                    duplicatesMap.set(key, []);
                }
                duplicatesMap.get(key).push(order);
            });
            
            duplicatesMap.forEach(orders => {
                if (orders.length > 1) {
                    orders.forEach(order => {
                        order.hasDuplicates = true;
                        order.duplicateGroup = orders.filter(o => o.id !== order.id);
                    });
                }
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        function displayOrders(orders) {
            const container = document.getElementById('orders-cards-container');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
                    </div>
                `;
                return;
            }
            
            let cardsHTML = '';
            orders.forEach((order) => {
                const isDuplicate = order.isDuplicate || order.hasDuplicates;
                const statusClass = order.status === 'Ù…ÙƒØªÙ…Ù„' ? 'completed' : 'pending';
                const duplicateClass = isDuplicate ? 'duplicate' : '';
                
                const statusBadge = order.status === 'Ù…ÙƒØªÙ…Ù„' 
                    ? '<span class="badge badge-success"><i class="fas fa-check-circle ml-1"></i> Ù…ÙƒØªÙ…Ù„</span>'
                    : '<span class="badge badge-warning"><i class="fas fa-clock ml-1"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
                
                const duplicateBadge = isDuplicate ? `
                    <div class="duplicate-badge">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ù…ÙƒØ±Ø±
                    </div>
                ` : '';
                
                const categoryDisplay = order.category 
                    ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold">ÙØ¦Ø© ${order.category}</span>`
                    : '<span class="text-gray-400">-</span>';
                
                const joinDateDisplay = order.joinDate 
                    ? order.joinDate 
                    : '<span class="text-gray-400">-</span>';
                
                const notesDisplay = order.notes 
                    ? `<div class="mt-2 p-3 bg-gray-50 rounded-lg">
                          <span class="text-xs text-gray-500 font-medium">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„:</span>
                          <p class="text-gray-700 text-sm mt-1">${order.notes}</p>
                       </div>`
                    : '';
                
                // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©
                const statusHistoryHTML = order.statusHistory ? `
                    <div class="mt-4 p-4 bg-gray-50 rounded-xl">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm font-medium text-gray-700">
                                <i class="fas fa-history ml-1"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©:
                            </span>
                            <span class="text-xs text-gray-500">${order.statusHistory.length} Ø­Ø¯Ø«</span>
                        </div>
                        <div class="timeline">
                            ${order.statusHistory.slice(-5).map(history => {
                                let icon, statusClass;
                                switch(history.status) {
                                    case 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…': icon = 'fa-inbox'; statusClass = 'received'; break;
                                    case 'ØªÙ… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©': icon = 'fa-eye'; statusClass = 'viewed'; break;
                                    case 'ØªÙ… Ø§Ù„Ø±Ø¯': icon = 'fa-reply'; statusClass = 'replied'; break;
                                    case 'Ù…ÙƒØªÙ…Ù„': icon = 'fa-check'; statusClass = 'completed'; break;
                                    default: icon = 'fa-circle'; statusClass = '';
                                }
                                const time = new Date(history.timestamp).toLocaleString('ar-EG');
                                return `
                                    <div class="timeline-item ${statusClass}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-sm font-medium text-gray-800">${history.status}</p>
                                                <p class="text-xs text-gray-500 mt-1">Ø¨ÙˆØ§Ø³Ø·Ø©: ${history.user}</p>
                                            </div>
                                            <p class="text-xs text-gray-500">${time}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '';
                
                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø±
                let duplicateInfo = '';
                if (isDuplicate) {
                    const duplicateMsg = order.isDuplicate 
                        ? '<p class="text-red-600 text-sm font-bold mt-2"><i class="fas fa-exclamation-triangle ml-1"></i> ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ ØªØ­Ø°ÙŠØ± Ø§Ù„ØªÙƒØ±Ø§Ø±</p>'
                        : '<p class="text-amber-600 text-sm font-bold mt-2"><i class="fas fa-clone ml-1"></i> Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨Ø§Øª Ø£Ø®Ø±Ù‰ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                    
                    duplicateInfo = `
                        <div class="mt-3 p-3 border border-red-200 rounded-lg bg-red-50">
                            <p class="text-red-700 text-sm font-bold flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                ØªÙ†Ø¨ÙŠÙ‡: Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
                            </p>
                            ${duplicateMsg}
                        </div>
                    `;
                }
                
                // Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                const adminNotesDisplay = order.adminNotes ? `
                    <div class="mt-4 p-4 bg-purple-50 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-purple-700">
                                <i class="fas fa-sticky-note ml-1"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:
                            </span>
                        </div>
                        <div class="admin-notes-content">
                            ${order.adminNotes}
                        </div>
                    </div>
                ` : '';
                
                let actionsHTML = '';
                if (appState.currentUser.role === 'admin') {
                    actionsHTML = `
                        <div class="flex gap-2 mt-4">
                            <button onclick="openReplyModal('${order.id}')" class="flex-1 btn btn-primary py-2 text-sm">
                                <i class="fas fa-reply ml-1"></i> Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                            </button>
                            <button onclick="deleteOrder('${order.id}')" class="btn btn-danger px-4">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                } else if (order.sender === appState.currentUser.name && order.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") {
                    actionsHTML = `
                        <div class="flex gap-2 mt-4">
                            <button onclick="deleteOrder('${order.id}')" class="flex-1 btn btn-danger py-2 text-sm">
                                <i class="fas fa-trash ml-1"></i> Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
                            </button>
                        </div>
                    `;
                }
                
                cardsHTML += `
                    <div class="order-card ${statusClass} ${duplicateClass}" data-id="${order.id}">
                        ${duplicateBadge}
                        
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 text-lg">${order.subjectName}</h4>
                                <p class="text-gray-600 text-sm mt-1">
                                    <i class="far fa-user ml-1"></i> ${order.sender}
                                </p>
                            </div>
                            <div class="flex flex-col items-end">
                                ${statusBadge}
                                <span class="text-xs text-gray-500 mt-2">${order.timestamp}</span>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="info-row">
                                <span class="label">Ø§Ù„Ø¬Ù†Ø³:</span>
                                <span class="value">${order.gender || '-'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span>
                                <span class="value">${order.birth || '-'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨:</span>
                                <span class="value">${joinDateDisplay}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Ø§Ù„ÙØ¦Ø©:</span>
                                <span class="value">${categoryDisplay}</span>
                            </div>
                        </div>
                        
                        ${notesDisplay}
                        ${duplicateInfo}
                        ${statusHistoryHTML}
                        
                        <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-blue-700">
                                    <i class="fas fa-comment-dots ml-1"></i> Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:
                                </span>
                                ${order.reply ? `
                                    <button onclick="copyReply('${order.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700">
                                        <i class="far fa-copy ml-1"></i> Ù†Ø³Ø®
                                    </button>
                                ` : ''}
                            </div>
                            <div class="reply-content">
                                ${order.reply || 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„...'}
                            </div>
                        </div>
                        
                        ${adminNotesDisplay}
                        
                        ${actionsHTML}
                    </div>
                `;
            });
            
            container.innerHTML = cardsHTML;
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Pagination
        function updatePagination() {
            const container = document.getElementById('pagination-container');
            const indicator = document.getElementById('infinite-scroll-indicator');
            
            if (appState.filteredOrders.length <= appState.pagination.ordersPerPage) {
                container.classList.add('hidden');
                indicator.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            let paginationHTML = '';
            const maxPagesToShow = 5;
            const startPage = Math.max(1, appState.pagination.page - Math.floor(maxPagesToShow / 2));
            const endPage = Math.min(appState.pagination.totalPages, startPage + maxPagesToShow - 1);
            
            // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            paginationHTML += `
                <button onclick="goToPage(${appState.pagination.page - 1})" 
                    ${appState.pagination.page === 1 ? 'disabled' : ''}
                    class="page-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            // ØµÙØ­Ø§Øª
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="goToPage(${i})" 
                        class="page-btn ${i === appState.pagination.page ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            paginationHTML += `
                <button onclick="goToPage(${appState.pagination.page + 1})" 
                    ${appState.pagination.page === appState.pagination.totalPages ? 'disabled' : ''}
                    class="page-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            container.innerHTML = paginationHTML;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ù„Ù…Ø²ÙŠØ¯
            if (appState.pagination.hasMore && appState.pagination.page < appState.pagination.totalPages) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ù…Ø¹ÙŠÙ†Ø©
        window.goToPage = function(page) {
            if (page < 1 || page > appState.pagination.totalPages) return;
            
            appState.pagination.page = page;
            updateDisplayedOrders();
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
            window.scrollTo({
                top: document.getElementById('orders-cards-container').offsetTop - 100,
                behavior: 'smooth'
            });
        };

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Infinite Scroll
        function setupInfiniteScroll() {
            let isLoading = false;
            
            window.addEventListener('scroll', () => {
                if (isLoading || !appState.pagination.hasMore) return;
                
                const container = document.getElementById('orders-cards-container');
                const scrollPosition = window.innerHeight + window.scrollY;
                const containerBottom = container.offsetTop + container.offsetHeight;
                
                if (scrollPosition >= containerBottom - 200) {
                    loadMoreOrders();
                }
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        async function loadMoreOrders() {
            if (appState.pagination.isLoadingMore || !appState.pagination.hasMore) return;
            
            appState.pagination.isLoadingMore = true;
            appState.pagination.page++;
            
            const indicator = document.getElementById('infinite-scroll-indicator');
            indicator.classList.remove('hidden');
            
            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ø·ÙŠØ¡ Ù„Ù„Ø¹Ø±Ø¶
            setTimeout(() => {
                updateDisplayedOrders();
                appState.pagination.isLoadingMore = false;
                indicator.classList.add('hidden');
            }, 300);
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        function updateDuplicateCounter() {
            if (appState.duplicateCount > 0) {
                document.getElementById('duplicate-count').classList.remove('hidden');
                document.getElementById('duplicate-number').innerText = appState.duplicateCount;
            } else {
                document.getElementById('duplicate-count').classList.add('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© Ù…Ø¹ Debouncing
        function setupSearchAndFilter() {
            let searchTimeout;
            const searchBox = document.getElementById('search-box');
            const filterStatus = document.getElementById('filter-status');
            
            searchBox.addEventListener('input', (e) => {
                appState.filters.search = e.target.value;
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    appState.pagination.page = 1;
                    updateDisplayedOrders();
                }, 300);
            });
            
            filterStatus.addEventListener('change', (e) => {
                appState.filters.status = e.target.value;
                appState.pagination.page = 1;
                updateDisplayedOrders();
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats(stats) {
            if (appState.currentUser.role === 'admin') {
                document.getElementById('stat-total').innerText = stats.total;
                document.getElementById('stat-pending').innerText = stats.pending;
                document.getElementById('stat-done').innerText = stats.done;
                document.getElementById('stat-duplicate').innerText = stats.duplicate;
            }
        }

        // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ø±Ø¯
        window.copyReply = function(orderId) {
            const order = appState.allOrders.find(o => o.id === orderId);
            if (!order || !order.reply) return;
            
            navigator.clipboard.writeText(order.reply)
                .then(() => alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­"))
                .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®"));
        };

        // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©
        window.openReplyModal = function(orderId) {
            const order = appState.allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            appState.selectedOrderId = orderId;
            
            document.getElementById('modal-title').innerText = 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©';
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø© - Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
            if (appState.currentUser.role === 'admin') {
                const viewedHistory = {
                    status: "ØªÙ… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©",
                    timestamp: Date.now(),
                    user: appState.currentUser.name
                };
                
                const updatedHistory = order.statusHistory ? [...order.statusHistory, viewedHistory] : [viewedHistory];
                
                update(ref(db, 'orders/' + orderId), {
                    statusHistory: updatedHistory
                });
            }
            
            const statusHistoryHTML = order.statusHistory ? `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-800 mb-3">
                        <i class="fas fa-history ml-1"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©
                    </h4>
                    <div class="timeline">
                        ${order.statusHistory.map(history => {
                            let icon, statusClass;
                            switch(history.status) {
                                case 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…': icon = 'fa-inbox'; statusClass = 'received'; break;
                                case 'ØªÙ… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©': icon = 'fa-eye'; statusClass = 'viewed'; break;
                                case 'ØªÙ… Ø§Ù„Ø±Ø¯': icon = 'fa-reply'; statusClass = 'replied'; break;
                                case 'Ù…ÙƒØªÙ…Ù„': icon = 'fa-check'; statusClass = 'completed'; break;
                                default: icon = 'fa-circle'; statusClass = '';
                            }
                            const time = new Date(history.timestamp).toLocaleString('ar-EG');
                            return `
                                <div class="timeline-item ${statusClass}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-sm font-medium text-gray-800">${history.status}</p>
                                            <p class="text-xs text-gray-500 mt-1">Ø¨ÙˆØ§Ø³Ø·Ø©: ${history.user}</p>
                                        </div>
                                        <p class="text-xs text-gray-500">${time}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '';
            
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ù… Ù…Ù†:</p>
                        <p class="font-bold text-lg">${order.sender}</p>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div>
                                <p class="text-sm text-gray-600">ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨:</p>
                                <p class="font-medium">${order.subjectName || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</p>
                                <p class="font-medium">${order.birth || '-'}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${statusHistoryHTML}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-edit ml-1"></i> Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ *
                        </label>
                        <textarea 
                            id="admin-reply-text" 
                            rows="4" 
                            class="w-full p-3"
                            placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù‡Ù†Ø§..."
                            required
                        >${order.reply || ''}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sticky-note ml-1"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                            <span class="text-gray-400 text-xs">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                        </label>
                        <textarea 
                            id="admin-notes-text" 
                            rows="3" 
                            class="w-full p-3"
                            placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ø§ØµØ©..."
                        >${order.adminNotes || ''}</textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-reply').classList.remove('hidden');
            document.getElementById('admin-reply-text').focus();
        };

        // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©
        window.saveReply = function() {
            const reply = document.getElementById('admin-reply-text').value.trim();
            const adminNotes = document.getElementById('admin-notes-text').value.trim();
            
            if (!reply) {
                alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            
            const order = appState.allOrders.find(o => o.id === appState.selectedOrderId);
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©
            const repliedHistory = {
                status: "ØªÙ… Ø§Ù„Ø±Ø¯",
                timestamp: Date.now(),
                user: appState.currentUser.name
            };
            
            const completedHistory = {
                status: "Ù…ÙƒØªÙ…Ù„",
                timestamp: Date.now(),
                user: appState.currentUser.name
            };
            
            const updatedHistory = order.statusHistory 
                ? [...order.statusHistory, repliedHistory, completedHistory]
                : [repliedHistory, completedHistory];
            
            const updates = {
                reply: reply,
                status: "Ù…ÙƒØªÙ…Ù„",
                replyTimestamp: new Date().toLocaleString('ar-EG'),
                statusHistory: updatedHistory
            };
            
            if (adminNotes) {
                updates.adminNotes = adminNotes;
            }
            
            update(ref(db, 'orders/' + appState.selectedOrderId), updates)
            .then(() => {
                sendNotification('order_replied', order.sender, 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', order.subjectName);
                sendNotification('order_completed', order.sender, 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…', order.subjectName);
                
                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
                closeModal();
                fetchOrders();
            })
            .catch(error => alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message));
        };

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
        window.deleteOrder = function(orderId) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
            
            remove(ref(db, 'orders/' + orderId))
                .then(() => {
                    alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                    fetchOrders();
                })
                .catch(error => alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message));
        };

        // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        window.closeModal = function() {
            document.getElementById('modal-reply').classList.add('hidden');
            appState.selectedOrderId = '';
        };

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.logout = function() {
            localStorage.clear();
            location.reload();
        };

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const session = localStorage.getItem('user_session');
        if (session) {
            const sessionData = JSON.parse(session);
            appState.currentUser = { name: sessionData.name, role: sessionData.role };
            showDashboard();
        }

        // ØªÙ‚ÙŠÙŠØ¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        document.getElementById('login-pass').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notifications-dropdown');
            const notificationsBtn = document.querySelector('.notifications-btn');
            
            if (dropdown && !dropdown.classList.contains('hidden') && 
                !dropdown.contains(event.target) && 
                !notificationsBtn.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Service Worker Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(err => {
                    console.log('SW registration failed:', err);
                });
            });
        }
    </script>
</body>
</html>