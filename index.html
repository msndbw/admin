<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>نظام إدارة الطلبات - كشف التكرار</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            font-family: 'Cairo', sans-serif; 
            box-sizing: border-box;
        }
        
        body { 
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        /* تصميم البطاقات الزجاجية */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* بطاقة الطلب */
        .order-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-right: 6px solid #3b82f6;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .order-card.duplicate {
            border-right: 6px solid #ef4444;
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
            animation: pulseWarning 2s infinite;
        }
        
        .order-card.completed {
            border-right: 6px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #fff 100%);
            opacity: 0.9;
        }
        
        .order-card.pending {
            border-right: 6px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);
        }
        
        @keyframes pulseWarning {
            0%, 100% { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1); }
            50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2); }
        }
        
        /* شارة التكرار */
        .duplicate-badge {
            position: absolute;
            top: -8px;
            left: 15px;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        
        /* نافذة التنبيه */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .alert-modal {
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            animation: alertSlideIn 0.4s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            border-top: 8px solid #ef4444;
        }
        
        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* المودال */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* الحقول */
        input, select, textarea {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* تحسين عرض الرد */
        .reply-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            color: #1e40af;
            font-weight: 700;
            background: #f8fafc;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        /* ملاحظات المسؤول */
        .admin-notes-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            color: #7c3aed;
            font-weight: 700;
            background: #f5f3ff;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #ddd6fe;
        }
        
        /* البادجات */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* الأزرار */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }
        
        /* زر الإشعارات */
        .notifications-btn {
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* تنسيقات الصور */
        .image-preview-container {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        
        .image-preview-container:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: block;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .remove-image-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #f1f5f9;
            color: #475569;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .remove-image-btn:hover {
            background: #e2e8f0;
        }
        
        .image-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .order-image {
            width: 100%;
            max-width: 300px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 15px 0;
        }
        
        .order-image:hover {
            transform: scale(1.02);
        }
        
        /* مودال عرض الصورة */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }
        
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .close-image-modal {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .close-image-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        /* تصميم متجاوب */
        @media (max-width: 640px) {
            .modal-content {
                padding: 20px;
                border-radius: 20px;
            }
            
            .alert-modal {
                padding: 20px;
                border-radius: 20px;
            }
            
            .image-modal-content {
                max-width: 95%;
                max-height: 80%;
            }
            
            .close-image-modal {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }

        /* إشعارات البوش */
        .push-notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .notification-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .notification-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .notification-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        /* تحسينات للهاتف */
        .section-divider {
            margin: 20px 0;
            padding: 10px 0;
            position: relative;
        }
        
        .section-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, #e2e8f0, transparent);
        }
        
        .section-title {
            background: white;
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
            position: relative;
            z-index: 1;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .pending-section {
            color: #f59e0b;
            border-color: #f59e0b;
        }
        
        .completed-section {
            color: #10b981;
            border-color: #10b981;
        }
        
        .order-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .order-info-row .label {
            color: #64748b;
            font-size: 13px;
        }
        
        .order-info-row .value {
            color: #1e293b;
            font-weight: 600;
            font-size: 13px;
        }
        
        /* تحسينات للأداء على الهاتف */
        .order-card {
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* مؤشر التحميل أثناء الفلترة */
        .filter-loading {
            display: none;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #64748b;
        }
        
        .filter-loading.active {
            display: block;
        }
        
        .spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* تحسينات للمعالجة على الهاتف */
        @media (max-width: 768px) {
            .order-card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .section-divider {
                margin: 16px 0;
            }
        }

        /* حالة الطلب */
        .order-status-timeline {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.pending {
            background: #f59e0b;
        }

        .status-dot.viewed {
            background: #3b82f6;
        }

        .status-dot.completed {
            background: #10b981;
        }

        .status-time {
            color: #64748b;
            font-size: 11px;
        }

        .status-label {
            font-weight: 600;
        }

        .status-separator {
            flex: 1;
            height: 1px;
            background: #e2e8f0;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- صفحة تسجيل الدخول -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-3xl p-10 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full mb-6 shadow-lg">
                    <i class="fas fa-shield-check text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-black text-gray-800 mb-2">نظام إدارة الطلبات</h1>
                <p class="text-gray-600 text-sm">مع نظام كشف التكرار الذكي</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key ml-1"></i> رمز الدخول
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="login-pass" 
                            class="w-full p-4 pr-12 border-2 border-gray-200 rounded-2xl text-center text-xl tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                            placeholder="أدخل رمز الدخول"
                            maxlength="4"
                        >
                        <i class="fas fa-key absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <button 
                    onclick="handleLogin()" 
                    class="w-full btn btn-primary py-4 rounded-2xl text-lg"
                >
                    <i class="fas fa-sign-in-alt ml-2"></i> دخول إلى النظام
                </button>
            </div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="main-app" class="hidden min-h-screen">
        <!-- شريط التنقل العلوي -->
        <header class="glass-card shadow-sm mb-6 mx-4 mt-4 rounded-2xl sticky top-4 z-40">
            <div class="flex justify-between items-center p-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-search-plus text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 id="user-display-name" class="font-bold text-lg text-gray-800"></h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="user-role-badge" class="badge"></span>
                            <button onclick="refreshOrders()" class="text-xs text-gray-500 hover:text-blue-600">
                                <i class="fas fa-sync-alt ml-1"></i> تحديث
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- زر الإشعارات -->
                    <button 
                        onclick="toggleNotifications()" 
                        class="notifications-btn relative p-3 text-gray-600 hover:text-blue-600 transition-colors"
                    >
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                    </button>
                    
                    <!-- قائمة الإشعارات -->
                    <div id="notifications-dropdown" class="hidden absolute top-20 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 max-h-96 overflow-y-auto">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">الإشعارات</h3>
                                <button onclick="markAllNotificationsAsRead()" class="text-sm text-blue-600 hover:text-blue-800">
                                    تعيين الكل كمقروء
                                </button>
                            </div>
                        </div>
                        <div id="notifications-list" class="p-2">
                            <!-- سيتم تعبئة الإشعارات هنا ديناميكياً -->
                        </div>
                    </div>
                    
                    <button 
                        onclick="logout()" 
                        class="btn btn-danger px-6"
                    >
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </div>
        </header>

        <!-- محتوى التطبيق -->
        <main class="max-w-4xl mx-auto px-4 pb-24">
            <!-- إحصائيات المسؤول -->
            <div id="admin-stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">إجمالي الطلبات</p>
                            <h3 id="stat-total" class="text-3xl font-bold text-gray-800">0</h3>
                        </div>
                        <i class="fas fa-file-alt text-blue-500 text-2xl"></i>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">قيد المراجعة</p>
                            <h3 id="stat-pending" class="text-3xl font-bold text-amber-600">0</h3>
                        </div>
                        <i class="fas fa-clock text-amber-500 text-2xl"></i>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">المكتملة</p>
                            <h3 id="stat-done" class="text-3xl font-bold text-emerald-600">0</h3>
                        </div>
                        <i class="fas fa-check-circle text-emerald-500 text-2xl"></i>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-medium mb-1">مكررة</p>
                            <h3 id="stat-duplicate" class="text-3xl font-bold text-red-600">0</h3>
                        </div>
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- قسم المستخدم - تقديم طلب جديد -->
            <div id="user-section" class="hidden mb-8">
                <div class="glass-card rounded-2xl p-6 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                            <i class="fas fa-plus text-white text-lg"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">تقديم طلب جديد</h2>
                    </div>
                    
                    <form id="request-form" class="space-y-6">
                        <!-- الصف الأول: الجنس والاسم -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user ml-1 text-gray-400"></i> الجنس *
                                </label>
                                <select id="gender" required class="w-full">
                                    <option value="">اختر الجنس</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user-tag ml-1 text-gray-400"></i> اسم صاحب الطلب
                                    <span class="text-gray-400 text-xs">(اختياري)</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="subject-name" 
                                    placeholder="الاسم الكامل"
                                >
                            </div>
                        </div>

                        <!-- الصف الثاني: تواريخ الميلاد والانتساب -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- تاريخ الميلاد -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-birthday-cake ml-1 text-gray-400"></i> تاريخ الميلاد *
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-day" 
                                            required 
                                            min="1" 
                                            max="31"
                                            placeholder="يوم"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-month" 
                                            required 
                                            min="1" 
                                            max="12"
                                            placeholder="شهر"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="b-year" 
                                            required 
                                            min="1900" 
                                            max="2026"
                                            placeholder="سنة"
                                            class="text-center"
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- تاريخ الانتساب -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt ml-1 text-gray-400"></i> تاريخ الانتساب
                                    <span class="text-gray-400 text-xs">(اختياري)</span>
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-day" 
                                            min="1" 
                                            max="31"
                                            placeholder="يوم"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-month" 
                                            min="1" 
                                            max="12"
                                            placeholder="شهر"
                                            class="text-center"
                                        >
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            id="j-year" 
                                            min="1900" 
                                            max="2026"
                                            placeholder="سنة"
                                            class="text-center"
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- الصف الثالث: الفئة والملاحظات -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- الفئة (اختياري) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-layer-group ml-1 text-gray-400"></i> الفئة
                                    <span class="text-gray-400 text-xs">(اختياري)</span>
                                </label>
                                <select id="category" class="w-full">
                                    <option value="">اختر الفئة (اختياري)</option>
                                    <option value="1">الفئة 1</option>
                                    <option value="2">الفئة 2</option>
                                    <option value="3">الفئة 3</option>
                                    <option value="4">الفئة 4</option>
                                    <option value="5">الفئة 5</option>
                                    <option value="6">الفئة 6</option>
                                    <option value="7">الفئة 7</option>
                                    <option value="8">الفئة 8</option>
                                    <option value="9">الفئة 9</option>
                                    <option value="10">الفئة 10</option>
                                    <option value="11">الفئة 11</option>
                                    <option value="12">الفئة 12</option>
                                    <option value="13">الفئة 13</option>
                                    <option value="14">الفئة 14</option>
                                    <option value="15">الفئة 15</option>
                                </select>
                            </div>

                            <!-- الملاحظات -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-sticky-note ml-1 text-gray-400"></i> الملاحظات
                                    <span class="text-gray-400 text-xs">(اختياري)</span>
                                </label>
                                <textarea 
                                    id="notes" 
                                    rows="3" 
                                    placeholder="أي تفاصيل أو معلومات إضافية..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- الصف الرابع: رفع الصورة (اختياري) -->
                        <div class="pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-image ml-1 text-gray-400"></i> رفع صورة
                                <span class="text-gray-400 text-xs">(اختياري)</span>
                            </label>
                            
                            <div id="image-upload-container">
                                <!-- الحالة الافتراضية: اختيار الصورة -->
                                <div id="no-image-section" class="image-preview-container">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                    <p class="text-gray-600 mb-4">اسحب وأفلت صورة هنا أو</p>
                                    <label for="image-upload" class="upload-btn">
                                        <i class="fas fa-image ml-1"></i> اختيار صورة
                                    </label>
                                    <input 
                                        type="file" 
                                        id="image-upload" 
                                        accept="image/*" 
                                        class="hidden"
                                        onchange="previewImage(event)"
                                    >
                                    <p class="text-xs text-gray-500 mt-3">الصيغ المدعومة: JPG, PNG, GIF (الحد الأقصى: 2MB)</p>
                                </div>
                                
                                <!-- الحالة: معاينة الصورة -->
                                <div id="image-preview-section" class="hidden">
                                    <div class="image-preview-container">
                                        <img id="image-preview" src="" alt="معاينة الصورة" class="image-preview">
                                        <div class="image-actions">
                                            <label for="image-upload" class="upload-btn">
                                                <i class="fas fa-sync-alt ml-1"></i> تغيير الصورة
                                            </label>
                                            <button type="button" onclick="removeImage()" class="remove-image-btn">
                                                <i class="fas fa-trash ml-1"></i> حذف الصورة
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- زر الإرسال -->
                        <div class="pt-4">
                            <button 
                                type="submit" 
                                id="submit-btn" 
                                class="w-full btn btn-primary py-4 rounded-2xl text-lg"
                            >
                                <i class="fas fa-search-check ml-2"></i> فحص وإرسال الطلب
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- قسم البحث والتصفية -->
            <div class="glass-card rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                        <i class="fas fa-history text-blue-600"></i>
                        سجل الطلبات
                        <span id="duplicate-count" class="hidden bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">
                            <i class="fas fa-exclamation-triangle ml-1"></i>
                            <span id="duplicate-number">0</span> مكررة
                        </span>
                    </h2>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full md:w-auto">
                        <div class="relative w-full sm:w-64">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input 
                                type="text" 
                                id="search-box" 
                                class="w-full p-3 pr-10 rounded-xl"
                                placeholder="ابحث بالاسم أو الملاحظات..."
                            >
                        </div>
                        
                        <select 
                            id="filter-status" 
                            class="w-full sm:w-auto p-3 rounded-xl"
                        >
                            <option value="">كل الحالات</option>
                            <option value="قيد المراجعة">قيد المراجعة</option>
                            <option value="مكتمل">مكتملة</option>
                            <option value="duplicate">مكررة فقط</option>
                        </select>
                    </div>
                </div>

                <!-- مؤشر التحميل أثناء الفلترة -->
                <div id="filter-loading" class="filter-loading">
                    <span>جاري التحميل...</span>
                    <div class="spinner-small"></div>
                </div>

                <!-- حاوية بطاقات الطلبات -->
                <div id="orders-cards-container">
                    <!-- سيتم إضافة البطاقات هنا ديناميكياً -->
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>جاري تحميل الطلبات...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- مودال رد المسؤول -->
    <div id="modal-reply" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">رد على الطلب</h3>
                <button 
                    onclick="closeModal()" 
                    class="text-gray-400 hover:text-gray-600 text-2xl"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-content" class="space-y-4">
                <!-- سيتم تعبئة المحتوى ديناميكياً -->
            </div>
            
            <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
                <button 
                    onclick="closeModal()" 
                    class="flex-1 btn btn-secondary py-3"
                >
                    إلغاء
                </button>
                <button 
                    id="modal-save-btn" 
                    onclick="saveReply()" 
                    class="flex-1 btn btn-primary py-3"
                >
                    <i class="fas fa-check ml-2"></i> حفظ الرد
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة تنبيه التكرار -->
    <div id="duplicate-alert" class="alert-overlay hidden">
        <div class="alert-modal">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-14 h-14 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-black text-gray-800">⚠️ تنبيه: طلب مكرر</h3>
                    <p class="text-gray-600 text-sm">تم اكتشاف طلب مسبق بنفس البيانات!</p>
                </div>
            </div>
            
            <div class="space-y-4" id="duplicate-alert-content">
                <!-- سيتم تعبئة محتوى التنبيه هنا -->
            </div>
            
            <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
                <button 
                    onclick="closeDuplicateAlert()" 
                    class="flex-1 btn btn-secondary py-3"
                >
                    <i class="fas fa-times ml-2"></i> إلغاء
                </button>
                <button 
                    id="force-submit-btn" 
                    onclick="forceSubmitOrder()" 
                    class="flex-1 btn btn-danger py-3"
                >
                    <i class="fas fa-exclamation-triangle ml-2"></i> إرسال مع التحذير
                </button>
            </div>
        </div>
    </div>

    <!-- مودال عرض الصورة بالحجم الكامل -->
    <div id="image-modal" class="image-modal hidden">
        <button onclick="closeImageModal()" class="close-image-modal">
            <i class="fas fa-times"></i>
        </button>
        <img id="full-size-image" src="" alt="الصورة بالحجم الكامل" class="image-modal-content">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOzouJz7ROysGrL2KoS6GPU046Mfq5EKg",
            authDomain: "damin-62c82.firebaseapp.com",
            databaseURL: "https://damin-62c82-default-rtdb.firebaseio.com",
            projectId: "damin-62c82",
            storageBucket: "damin-62c82.firebasestorage.app",
            messagingSenderId: "787751266614",
            appId: "1:787751266614:web:4045deaf010156db4eab97"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // إضافة المستخدم الجديد: صفحة التقاعد الاختياري
        const usersMap = {
            "0780": { name: "المسؤول العام", role: "admin" },
            "2004": { name: "مهدي أحمد", role: "user" },
            "1982": { name: "مهند علي (أبو سيف)", role: "user" },
            "2001": { name: "مهدي (د. إيهاب)", role: "user" },
            "1996": { name: "حيدر الكرعاوي", role: "user" },
            "1234": { name: "مستخدم تجريبي", role: "user" },
            "2026": { name: "صفحة التقاعد الاختياري", role: "user" }
        };

        let currentUser = null;
        let allOrders = [];
        let selectedOrderId = '';
        let currentNewOrderData = null;
        let duplicateOrders = [];
        let duplicateCount = 0;
        let notifications = [];
        let selectedImageFile = null;
        let imagePreviewUrl = null;
        let filterTimeout = null;
        let isFiltering = false;

        // دالة عرض الإشعار العائم
        function showPushNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `push-notification notification-${type}`;
            
            let icon;
            switch(type) {
                case 'success': icon = 'fa-check-circle'; break;
                case 'warning': icon = 'fa-exclamation-triangle'; break;
                default: icon = 'fa-bell';
            }
            
            notification.innerHTML = `
                <div class="notification-icon ${type === 'success' ? 'notification-success' : type === 'warning' ? 'notification-warning' : 'notification-info'}">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800">${title}</h4>
                    <p class="text-sm text-gray-600">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // إزالة الإشعار بعد 5 ثواني
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // دالة تحويل الصورة إلى Base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // دالة تسجيل الدخول
        window.handleLogin = function() {
            const pass = document.getElementById('login-pass').value.trim();
            if (usersMap[pass]) {
                currentUser = usersMap[pass];
                
                // حفظ بيانات الجلسة
                const sessionData = {
                    ...currentUser,
                    loginTime: new Date().toISOString()
                };
                localStorage.setItem('user_session', JSON.stringify(sessionData));
                
                showDashboard();
                fetchNotifications();
                
                // طلب إذن الإشعارات من المتصفح
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            showPushNotification('تم تفعيل الإشعارات', 'سيتم إعلامك بجميع التحديثات الجديدة', 'success');
                        }
                    });
                }
                
                showPushNotification('مرحباً ' + currentUser.name, 'تم تسجيل الدخول بنجاح', 'success');
            } else {
                alert("رمز الدخول غير صحيح!");
            }
        }

        // دالة عرض لوحة التحكم
        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // تحديث معلومات المستخدم
            document.getElementById('user-display-name').innerText = currentUser.name;
            
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.innerText = currentUser.role === 'admin' ? "مدير النظام" : "مستخدم";
            roleBadge.className = currentUser.role === 'admin' 
                ? 'badge badge-success' 
                : 'badge badge-info';
            
            // إظهار الأقسام المناسبة
            if (currentUser.role === 'admin') {
                document.getElementById('admin-stats').classList.remove('hidden');
                document.getElementById('user-section').classList.add('hidden');
            } else {
                document.getElementById('admin-stats').classList.add('hidden');
                document.getElementById('user-section').classList.remove('hidden');
            }
            
            fetchOrders();
            setupSearchAndFilter();
        }

        // دالة تحديث الطلبات
        window.refreshOrders = function() {
            fetchOrders();
            fetchNotifications();
            showPushNotification('تم التحديث', 'تم تحديث قائمة الطلبات', 'info');
        }

        // دالة جلب الإشعارات
        function fetchNotifications() {
            if (!currentUser) return;
            
            onValue(ref(db, 'notifications'), (snapshot) => {
                const data = snapshot.val();
                notifications = [];
                
                if (data) {
                    for (let id in data) {
                        const notif = { id, ...data[id] };
                        
                        // عرض الإشعارات للمستخدم المناسب
                        if (currentUser.role === 'admin' || 
                            (notif.targetUser === currentUser.name && !notif.read)) {
                            notifications.push(notif);
                        }
                    }
                }
                
                updateNotificationsUI();
            });
        }

        // دالة تحديث واجهة الإشعارات
        function updateNotificationsUI() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');
            
            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
            } else {
                badge.classList.add('hidden');
            }
            
            // إظهار إشعارات المتصفح للطلبات الجديدة
            showBrowserNotifications();
        }

        // دالة عرض إشعارات المتصفح
        function showBrowserNotifications() {
            if (!("Notification" in window)) return;
            
            const newNotifications = notifications.filter(n => 
                !n.read && 
                (n.type === 'new_order' || n.type === 'order_replied' || n.type === 'order_completed')
            );
            
            newNotifications.forEach(notif => {
                if (Notification.permission === "granted") {
                    let title, body;
                    
                    switch(notif.type) {
                        case 'new_order':
                            title = '📋 طلب جديد';
                            body = `طلب جديد من ${notif.sender}`;
                            break;
                        case 'order_replied':
                            title = '💬 رد على طلبك';
                            body = `تم الرد على طلبك من قبل المسؤول`;
                            break;
                        case 'order_completed':
                            title = '✅ اكتمال الطلب';
                            body = `تم إكمال طلبك بنجاح`;
                            break;
                    }
                    
                    new Notification(title, {
                        body: body,
                        icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                        tag: notif.id
                    });
                    
                    // إشعار عائم
                    showPushNotification(title, body, 'info');
                }
                
                // تحديث حالة الإشعار كمقروء
                if (!notif.read) {
                    update(ref(db, 'notifications/' + notif.id), { read: true });
                }
            });
        }

        // دالة تبديل عرض الإشعارات
        window.toggleNotifications = function() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                displayNotificationsList();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // دالة عرض قائمة الإشعارات
        function displayNotificationsList() {
            const listContainer = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-bell-slash text-3xl mb-3"></i>
                        <p>لا توجد إشعارات</p>
                    </div>
                `;
                return;
            }
            
            // ترتيب الإشعارات من الأحدث إلى الأقدم
            const sortedNotifications = [...notifications].sort((a, b) => b.timestamp - a.timestamp);
            
            let listHTML = '';
            sortedNotifications.forEach(notif => {
                const timeAgo = getTimeAgo(notif.timestamp);
                const isReadClass = notif.read ? 'opacity-70' : 'bg-blue-50';
                
                let icon, color, text;
                
                switch(notif.type) {
                    case 'new_order':
                        icon = 'fa-file-alt';
                        color = 'text-blue-600';
                        text = `طلب جديد من ${notif.sender}`;
                        break;
                    case 'order_replied':
                        icon = 'fa-reply';
                        color = 'text-green-600';
                        text = `رد المسؤول على طلبك`;
                        break;
                    case 'order_completed':
                        icon = 'fa-check-circle';
                        color = 'text-emerald-600';
                        text = `تم إكمال طلبك`;
                        break;
                    case 'duplicate_warning':
                        icon = 'fa-exclamation-triangle';
                        color = 'text-red-600';
                        text = `تنبيه: طلب مكرر من ${notif.sender}`;
                        break;
                    default:
                        icon = 'fa-bell';
                        color = 'text-gray-600';
                        text = notif.message || 'إشعار جديد';
                }
                
                listHTML += `
                    <div class="notification-item p-3 border-b border-gray-100 hover:bg-gray-50 ${isReadClass}" onclick="markNotificationAsRead('${notif.id}')">
                        <div class="flex items-start gap-3">
                            <div class="${color}">
                                <i class="fas ${icon} text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${text}</p>
                                ${notif.orderSubject ? `
                                    <p class="text-xs text-gray-600 mt-1">الطلب: ${notif.orderSubject}</p>
                                ` : ''}
                                <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                            </div>
                            ${!notif.read ? `
                                <span class="w-2 h-2 bg-blue-500 rounded-full mt-2"></span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = listHTML;
        }

        // دالة حساب الوقت المنقضي
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'الآن';
            if (minutes < 60) return `منذ ${minutes} دقيقة`;
            if (hours < 24) return `منذ ${hours} ساعة`;
            return `منذ ${days} يوم`;
        }

        // دالة تعيين إشعار كمقروء
        window.markNotificationAsRead = function(notificationId) {
            update(ref(db, 'notifications/' + notificationId), { read: true })
                .then(() => {
                    fetchNotifications();
                });
        }

        // دالة تعيين جميع الإشعارات كمقروءة
        window.markAllNotificationsAsRead = function() {
            notifications.forEach(notif => {
                if (!notif.read) {
                    update(ref(db, 'notifications/' + notif.id), { read: true });
                }
            });
            showPushNotification('تم تعيين الكل كمقروء', 'تمت قراءة جميع الإشعارات', 'success');
        }

        // دالة إرسال إشعار
        function sendNotification(type, targetUser, sender, orderSubject = '', orderId = '') {
            const notificationData = {
                type: type,
                targetUser: targetUser,
                sender: sender,
                orderSubject: orderSubject,
                orderId: orderId,
                timestamp: Date.now(),
                read: false
            };
            
            push(ref(db, 'notifications'), notificationData);
            
            // إشعار فوري للمستخدم إذا كان موجوداً في النظام
            if (currentUser && (currentUser.name === targetUser || currentUser.role === 'admin')) {
                let title, message;
                switch(type) {
                    case 'new_order':
                        title = '📋 طلب جديد';
                        message = `طلب جديد من ${sender}`;
                        break;
                    case 'order_replied':
                        title = '💬 رد على طلبك';
                        message = `تم الرد على طلبك من قبل المسؤول`;
                        break;
                    case 'order_completed':
                        title = '✅ اكتمال الطلب';
                        message = `تم إكمال طلبك بنجاح`;
                        break;
                    case 'duplicate_warning':
                        title = '⚠️ تنبيه تكرار';
                        message = `تم اكتشاف طلب مكرر من ${sender}`;
                        break;
                }
                
                showPushNotification(title, message, type === 'duplicate_warning' ? 'warning' : 'info');
            }
        }

        // دالة معاينة الصورة
        window.previewImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // التحقق من نوع الملف
            if (!file.type.match('image.*')) {
                alert('يرجى اختيار ملف صورة فقط');
                return;
            }
            
            // التحقق من حجم الملف (2MB كحد أقصى)
            if (file.size > 2 * 1024 * 1024) {
                alert('حجم الصورة كبير جداً. الحد الأقصى هو 2MB');
                return;
            }
            
            selectedImageFile = file;
            
            // إنشاء URL للمعاينة
            imagePreviewUrl = URL.createObjectURL(file);
            
            // عرض المعاينة
            const previewImg = document.getElementById('image-preview');
            previewImg.src = imagePreviewUrl;
            
            // تبديل الأقسام
            document.getElementById('no-image-section').classList.add('hidden');
            document.getElementById('image-preview-section').classList.remove('hidden');
            
            showPushNotification('تم رفع الصورة', 'تمت معاينة الصورة بنجاح', 'success');
        };

        // دالة حذف الصورة
        window.removeImage = function() {
            selectedImageFile = null;
            if (imagePreviewUrl) {
                URL.revokeObjectURL(imagePreviewUrl);
                imagePreviewUrl = null;
            }
            
            // إعادة تعيين حقل الرفع
            document.getElementById('image-upload').value = '';
            
            // تبديل الأقسام
            document.getElementById('no-image-section').classList.remove('hidden');
            document.getElementById('image-preview-section').classList.add('hidden');
            
            showPushNotification('تم حذف الصورة', 'تم إزالة الصورة المرفوعة', 'info');
        };

        // دالة الكشف عن التكرار بناءً على البيانات الأربعة
        function checkForDuplicates(newOrder) {
            duplicateOrders = [];
            
            allOrders.forEach(existingOrder => {
                // 1. مقارنة الجنس (مطلوب)
                const genderMatch = newOrder.gender === existingOrder.gender;
                
                // 2. مقارنة تاريخ الميلاد (مطلوب)
                const birthMatch = newOrder.birth === existingOrder.birth;
                
                // 3. مقارنة تاريخ الانتساب (إذا كان موجوداً في كلا الطلبين)
                let joinMatch = false;
                if (newOrder.joinDate && existingOrder.joinDate) {
                    // كلا الطلبين يحتويان على تاريخ انتساب - يجب أن يتطابقا
                    joinMatch = newOrder.joinDate === existingOrder.joinDate;
                } else if (!newOrder.joinDate && !existingOrder.joinDate) {
                    // كلاهما فارغ - يعتبر تطابق
                    joinMatch = true;
                } else if (!newOrder.joinDate || !existingOrder.joinDate) {
                    // أحدهما فارغ والآخر ليس فارغاً - لا يعتبر تطابق (تعديل بناءً على طلب العميل)
                    joinMatch = false;
                }
                
                // 4. مقارنة الفئة (إذا كانت موجودة في كلا الطلبين)
                let categoryMatch = false;
                if (newOrder.category && existingOrder.category) {
                    // كلا الطلبين يحتويان على فئة - يجب أن يتطابقا
                    categoryMatch = newOrder.category === existingOrder.category;
                } else if (!newOrder.category && !existingOrder.category) {
                    // كلاهما فارغ - يعتبر تطابق
                    categoryMatch = true;
                } else if (!newOrder.category || !existingOrder.category) {
                    // أحدهما فارغ والآخر ليس فارغاً - لا يعتبر تطابق (تعديل بناءً على طلب العميل)
                    categoryMatch = false;
                }
                
                // الكشف عن التكرار إذا تطابقت جميع الحقول الأربعة
                if (genderMatch && birthMatch && joinMatch && categoryMatch) {
                    duplicateOrders.push(existingOrder);
                }
            });
            
            return duplicateOrders.length > 0;
        }

        // دالة إرسال الطلب الجديد مع فحص التكرار
        document.getElementById('request-form').onsubmit = async (e) => {
            e.preventDefault();
            
            // جمع البيانات من النموذج
            const gender = document.getElementById('gender').value;
            const subjectName = document.getElementById('subject-name').value.trim();
            const category = document.getElementById('category').value;
            const bDay = document.getElementById('b-day').value;
            const bMonth = document.getElementById('b-month').value;
            const bYear = document.getElementById('b-year').value;
            const jDay = document.getElementById('j-day').value;
            const jMonth = document.getElementById('j-month').value;
            const jYear = document.getElementById('j-year').value;
            const notes = document.getElementById('notes').value.trim();
            
            // التحقق من الحقول المطلوبة (الجنس وتاريخ الميلاد فقط)
            if (!gender || !bDay || !bMonth || !bYear) {
                alert("الرجاء ملء الجنس وتاريخ الميلاد (الحقول المطلوبة)");
                return;
            }
            
            // التحقق من وجود بيانات (صورة أو اسم)
            if (!subjectName && !selectedImageFile) {
                if (!confirm("لم تقم بإضافة صورة أو اسم للطلب. هل تريد المتابعة؟")) {
                    return;
                }
            }
            
            // إعداد بيانات الطلب الجديد
            const birthDate = `${bDay}/${bMonth}/${bYear}`;
            let joinDate = '';
            if (jDay && jMonth && jYear) {
                joinDate = `${jDay}/${jMonth}/${jYear}`;
            }
            
            const newOrderData = {
                sender: currentUser.name,
                gender: gender,
                subjectName: subjectName || 'بدون اسم',
                category: category || '',
                birth: birthDate,
                joinDate: joinDate,
                notes: notes,
                status: "قيد المراجعة",
                reply: "",
                adminNotes: "",
                timestamp: new Date().toLocaleString('ar-EG'),
                timestampOrder: Date.now(),
                senderId: currentUser.name.replace(/\s+/g, '_') + '_' + Date.now(),
                // إضافة حقول تتبع الحالة
                statusTimeline: {
                    pending: {
                        status: "قيد المراجعة",
                        time: new Date().toLocaleString('ar-EG'),
                        timestamp: Date.now()
                    }
                }
            };
            
            // حفظ بيانات الطلب الحالية لاستخدامها لاحقاً
            currentNewOrderData = newOrderData;
            
            // فحص التكرار
            const hasDuplicates = checkForDuplicates(newOrderData);
            
            if (hasDuplicates) {
                // عرض نافذة التنبيه
                showDuplicateAlert(duplicateOrders, newOrderData);
            } else {
                // لا يوجد تكرار، المتابعة في الإرسال العادي
                await submitOrder(newOrderData, selectedImageFile);
            }
        };

        // دالة عرض تنبيه التكرار (مخصصة للمستخدم والمسؤول فقط)
        function showDuplicateAlert(duplicates, newOrder) {
            // التحقق إذا كان المستخدم الحالي هو المسؤول أو مقدم الطلب
            if (currentUser.role !== 'admin' && newOrder.sender !== currentUser.name) {
                // إذا لم يكن مسؤولاً وليس مقدم الطلب، تخطي التنبيه
                submitOrder(newOrder, selectedImageFile);
                return;
            }
            
            let alertContent = `
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                    <p class="font-bold text-red-700 mb-2">تفاصيل الطلب الجديد:</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">الجنس:</span>
                            <span class="font-bold">${newOrder.gender}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">تاريخ الميلاد:</span>
                            <span class="font-bold">${newOrder.birth}</span>
                        </div>
                        ${newOrder.joinDate ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">تاريخ الانتساب:</span>
                            <span class="font-bold">${newOrder.joinDate}</span>
                        </div>
                        ` : ''}
                        ${newOrder.category ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">الفئة:</span>
                            <span class="font-bold">فئة ${newOrder.category}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <p class="font-bold text-amber-700 mb-3">
                        <i class="fas fa-exclamation-circle ml-1"></i>
                        تم العثور على ${duplicates.length} طلب مكرر سابقاً:
                    </p>
            `;
            
            duplicates.forEach((dup, index) => {
                const duplicateDate = new Date(dup.timestampOrder).toLocaleString('ar-EG');
                alertContent += `
                    <div class="mb-3 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-gray-800">${index + 1}. ${dup.subjectName}</span>
                            <span class="text-xs text-gray-500">${duplicateDate}</span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex justify-between">
                                <span>المرسل:</span>
                                <span class="font-bold">${dup.sender}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>حالة الطلب:</span>
                                <span class="font-bold ${dup.status === 'مكتمل' ? 'text-green-600' : 'text-amber-600'}">${dup.status}</span>
                            </div>
                            ${dup.reply ? `
                            <div class="mt-2">
                                <span class="text-gray-500">رد المسؤول:</span>
                                <p class="text-gray-700 text-xs mt-1 bg-gray-100 p-2 rounded">${dup.reply.substring(0, 100)}${dup.reply.length > 100 ? '...' : ''}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            alertContent += `
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mt-4">
                    <p class="text-blue-700 text-sm flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        <span>هذا التنبيه يظهر فقط للمسؤول ومقدم الطلب لمنع التكرار</span>
                    </p>
                </div>
            `;
            
            document.getElementById('duplicate-alert-content').innerHTML = alertContent;
            document.getElementById('duplicate-alert').classList.remove('hidden');
            
            // إرسال إشعار للمسؤولين إذا كان المستخدم ليس مسؤول
            if (currentUser.role !== 'admin') {
                sendDuplicateNotificationToAdmins(newOrder, duplicates);
            }
        }

        // دالة إرسال إشعار التكرار للمسؤولين فقط
        function sendDuplicateNotificationToAdmins(newOrder, duplicates) {
            // إرسال إشعار للمسؤول العام فقط
            sendNotification('duplicate_warning', 'المسؤول العام', currentUser.name, newOrder.subjectName);
            
            const notificationData = {
                type: 'duplicate_warning',
                newOrder: newOrder,
                duplicateCount: duplicates.length,
                timestamp: Date.now(),
                notifiedAdmins: true,
                // تحديد أن الإشعار للمسؤول فقط
                forAdminOnly: true
            };
            
            // تخزين الإشعار في قاعدة البيانات للمسؤولين
            try {
                push(ref(db, 'admin_notifications'), notificationData);
            } catch (error) {
                console.log("تم اكتشاف تكرار، ولكن لم يتم إرسال إشعار للمسؤولين:", error);
            }
        }

        // دالة الإرسال القسري (مع التحذير)
        window.forceSubmitOrder = async function() {
            if (!currentNewOrderData) return;
            
            const btn = document.getElementById('force-submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الإرسال...';
            
            // إضافة علامة أن الطلب مكرر
            currentNewOrderData.isDuplicate = true;
            currentNewOrderData.duplicateWarning = `⚠️ تنبيه: هذا الطلب مكرر ${duplicateOrders.length} مرة سابقة`;
            currentNewOrderData.duplicateReferences = duplicateOrders.map(d => d.id);
            
            try {
                // تحويل الصورة إلى Base64 إذا كانت موجودة
                if (selectedImageFile) {
                    try {
                        const base64Image = await convertImageToBase64(selectedImageFile);
                        currentNewOrderData.imageData = base64Image;
                        currentNewOrderData.hasImage = true;
                        currentNewOrderData.imageName = selectedImageFile.name;
                    } catch (imageError) {
                        console.error('خطأ في تحويل الصورة:', imageError);
                        alert('حدث خطأ في معالجة الصورة. سيتم إرسال الطلب بدون الصورة.');
                    }
                }
                
                // إرسال الطلب
                await push(ref(db, 'orders'), currentNewOrderData);
                
                // إرسال إشعار للمسؤول عن الطلب الجديد
                sendNotification('new_order', 'المسؤول العام', currentUser.name, currentNewOrderData.subjectName);
                
                showPushNotification('تم إرسال الطلب', `تم إرسال الطلب مع تحذير التكرار (${duplicateOrders.length} مكرر)`, 'success');
                
                // إغلاق نافذة التنبيه
                closeDuplicateAlert();
                
                // إعادة تعيين النموذج
                document.getElementById('request-form').reset();
                removeImage();
                
                // تحديث قائمة الطلبات
                fetchOrders();
            } catch (error) {
                showPushNotification('خطأ في الإرسال', error.message, 'warning');
                alert("حدث خطأ في إرسال الطلب: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle ml-2"></i> إرسال مع التحذير';
            }
        };

        // دالة الإرسال العادي (بدون تكرار)
        async function submitOrder(orderData, imageFile, isForceSubmit = false) {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الإرسال...';
            
            try {
                // تحويل الصورة إلى Base64 إذا كانت موجودة
                if (imageFile) {
                    try {
                        const base64Image = await convertImageToBase64(imageFile);
                        orderData.imageData = base64Image;
                        orderData.hasImage = true;
                        orderData.imageName = imageFile.name;
                    } catch (imageError) {
                        console.error('خطأ في تحويل الصورة:', imageError);
                        alert('حدث خطأ في معالجة الصورة. سيتم إرسال الطلب بدون الصورة.');
                    }
                }
                
                // إرسال الطلب
                await push(ref(db, 'orders'), orderData);
                
                // إرسال إشعار للمسؤول عن الطلب الجديد
                sendNotification('new_order', 'المسؤول العام', currentUser.name, orderData.subjectName);
                
                if (!isForceSubmit) {
                    showPushNotification('تم إرسال الطلب', 'تم إرسال الطلب بنجاح', 'success');
                    document.getElementById('request-form').reset();
                    removeImage();
                } else {
                    showPushNotification('تم إرسال الطلب', `تم إرسال الطلب مع تحذير التكرار (${duplicateOrders.length} مكرر)`, 'success');
                }
                
                fetchOrders();
            } catch (error) {
                console.error("حدث خطأ في إرسال الطلب:", error);
                showPushNotification('خطأ في الإرسال', error.message, 'warning');
                alert("حدث خطأ في إرسال الطلب: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search-check ml-2"></i> فحص وإرسال الطلب';
            }
        }

        // دالة إغلاق نافذة التنبيه
        window.closeDuplicateAlert = function() {
            document.getElementById('duplicate-alert').classList.add('hidden');
            currentNewOrderData = null;
            duplicateOrders = [];
        };

        // دالة فتح الصورة بالحجم الكامل
        window.openImageModal = function(imageUrl) {
            document.getElementById('full-size-image').src = imageUrl;
            document.getElementById('image-modal').classList.remove('hidden');
        };

        // دالة إغلاق مودال الصورة
        window.closeImageModal = function() {
            document.getElementById('image-modal').classList.add('hidden');
            document.getElementById('full-size-image').src = '';
        };

        // دالة جلب الطلبات
        function fetchOrders() {
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                allOrders = [];
                duplicateCount = 0;
                let stats = { total: 0, pending: 0, done: 0, duplicate: 0 };
                
                if (data) {
                    for (let id in data) {
                        const order = { id, ...data[id] };
                        allOrders.push(order);
                        stats.total++;
                        if (order.status === "قيد المراجعة") stats.pending++; else stats.done++;
                        
                        // حساب الطلبات المكررة
                        if (order.isDuplicate) {
                            duplicateCount++;
                        }
                    }
                    
                    // الكشف عن التكرار في الطلبات الموجودة
                    detectExistingDuplicates();
                    
                    // ترتيب الطلبات من الأحدث إلى الأقدم
                    allOrders.sort((a, b) => (b.timestampOrder || 0) - (a.timestampOrder || 0));
                }
                
                stats.duplicate = duplicateCount;
                displayOrders(allOrders);
                updateStats(stats);
            });
        }

        // دالة الكشف عن التكرار في الطلبات الموجودة
        function detectExistingDuplicates() {
            const duplicatesMap = new Map();
            
            // إنشاء مفتوح فريد لكل طلب بناءً على البيانات الأربعة
            allOrders.forEach(order => {
                const key = `${order.gender}_${order.birth}_${order.joinDate || 'nojoin'}_${order.category || 'nocat'}`;
                
                if (!duplicatesMap.has(key)) {
                    duplicatesMap.set(key, []);
                }
                duplicatesMap.get(key).push(order);
            });
            
            // تحديث علامات التكرار
            duplicatesMap.forEach(orders => {
                if (orders.length > 1) {
                    orders.forEach(order => {
                        order.hasDuplicates = true;
                        order.duplicateGroup = orders.filter(o => o.id !== order.id);
                    });
                }
            });
        }

        // دالة عرض الطلبات مع ترتيب محسّن
        function displayOrders(orders) {
            if (isFiltering) {
                return; // تجنب التحديثات المتعددة المتزامنة
            }
            
            const container = document.getElementById('orders-cards-container');
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const filter = document.getElementById('filter-status').value;
            
            // إظهار مؤشر التحميل على الهاتف
            const isMobile = window.innerWidth < 768;
            const loadingIndicator = document.getElementById('filter-loading');
            
            if (isMobile) {
                isFiltering = true;
                loadingIndicator.classList.add('active');
                
                // استخدام setTimeout لتجنب تجميد واجهة المستخدم
                setTimeout(() => {
                    performFilterAndDisplay(orders, container, searchTerm, filter, isMobile);
                }, 50);
            } else {
                performFilterAndDisplay(orders, container, searchTerm, filter, isMobile);
            }
        }

        // دالة تنفيذ الفلترة والعرض
        function performFilterAndDisplay(orders, container, searchTerm, filter, isMobile) {
            try {
                // تصفية الطلبات
                let filteredOrders = orders.filter(o => {
                    if (currentUser.role !== 'admin' && o.sender !== currentUser.name) return false;
                    if (searchTerm && !o.subjectName.toLowerCase().includes(searchTerm) && !o.notes.toLowerCase().includes(searchTerm)) return false;
                    if (filter === 'duplicate' && !o.isDuplicate && !o.hasDuplicates) return false;
                    if (filter && filter !== 'duplicate' && o.status !== filter) return false;
                    return true;
                });
                
                // تحسين الترتيب: الطلبات قيد المراجعة أولاً، ثم المكتملة
                filteredOrders.sort((a, b) => {
                    // أولاً: ترتيب حسب الحالة (قيد المراجعة أولاً)
                    if (a.status === 'قيد المراجعة' && b.status !== 'قيد المراجعة') return -1;
                    if (a.status !== 'قيد المراجعة' && b.status === 'قيد المراجعة') return 1;
                    
                    // ثانياً: ترتيب حسب التاريخ (الأحدث أولاً)
                    return (b.timestampOrder || 0) - (a.timestampOrder || 0);
                });
                
                if (filteredOrders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">لا توجد طلبات لعرضها</p>
                        </div>
                    `;
                    updateDuplicateCounter();
                    isFiltering = false;
                    document.getElementById('filter-loading').classList.remove('active');
                    return;
                }
                
                // تجميع البطاقات في أقسام
                let cardsHTML = '';
                let hasPending = false;
                let hasCompleted = false;
                
                // قسم الطلبات قيد المراجعة
                let pendingOrders = filteredOrders.filter(o => o.status === 'قيد المراجعة');
                if (pendingOrders.length > 0 && (!filter || filter === '' || filter === 'قيد المراجعة')) {
                    hasPending = true;
                    cardsHTML += `
                        <div class="section-divider">
                            <div class="section-title pending-section">
                                <i class="fas fa-clock ml-2"></i>
                                الطلبات قيد المراجعة (${pendingOrders.length})
                            </div>
                        </div>
                    `;
                    
                    pendingOrders.forEach((order) => {
                        cardsHTML += generateOrderCardHTML(order);
                    });
                }
                
                // قسم الطلبات المكتملة
                let completedOrders = filteredOrders.filter(o => o.status === 'مكتمل');
                if (completedOrders.length > 0 && (!filter || filter === '' || filter === 'مكتمل')) {
                    hasCompleted = true;
                    if (hasPending) {
                        cardsHTML += `
                            <div class="section-divider">
                                <div class="section-title completed-section">
                                    <i class="fas fa-check-circle ml-2"></i>
                                    الطلبات المكتملة (${completedOrders.length})
                                </div>
                            </div>
                        `;
                    } else {
                        cardsHTML += `
                            <div class="section-divider">
                                <div class="section-title completed-section">
                                    <i class="fas fa-check-circle ml-2"></i>
                                    الطلبات المكتملة (${completedOrders.length})
                                </div>
                            </div>
                        `;
                    }
                    
                    completedOrders.forEach((order) => {
                        cardsHTML += generateOrderCardHTML(order);
                    });
                }
                
                // إذا كان هناك فلتر محدد ولم تظهر أي أقسام
                if ((filter === 'قيد المراجعة' && !hasPending) || (filter === 'مكتمل' && !hasCompleted)) {
                    const filterName = filter === 'قيد المراجعة' ? 'قيد المراجعة' : 'المكتملة';
                    cardsHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">لا توجد طلبات ${filterName}</p>
                        </div>
                    `;
                }
                
                // تحديث واجهة المستخدم مع التحسين للأداء
                if (isMobile) {
                    // على الهاتف، استخدام requestAnimationFrame لتحسين الأداء
                    requestAnimationFrame(() => {
                        container.innerHTML = cardsHTML;
                        updateDuplicateCounter();
                        isFiltering = false;
                        document.getElementById('filter-loading').classList.remove('active');
                    });
                } else {
                    container.innerHTML = cardsHTML;
                    updateDuplicateCounter();
                    isFiltering = false;
                    document.getElementById('filter-loading').classList.remove('active');
                }
            } catch (error) {
                console.error("خطأ في عرض الطلبات:", error);
                container.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p class="text-lg font-medium">حدث خطأ في عرض الطلبات</p>
                        <p class="text-sm mt-2">يرجى تحديث الصفحة</p>
                    </div>
                `;
                isFiltering = false;
                document.getElementById('filter-loading').classList.remove('active');
            }
        }

        // دالة إنشاء HTML لبطاقة الطلب
        function generateOrderCardHTML(order) {
            const isDuplicate = order.isDuplicate || order.hasDuplicates;
            const statusClass = order.status === 'مكتمل' ? 'completed' : 'pending';
            const duplicateClass = isDuplicate ? 'duplicate' : '';
            
            // إظهار علامة التكرار فقط للمسؤول ومقدم الطلب
            let showDuplicateBadge = false;
            if (isDuplicate) {
                if (currentUser.role === 'admin' || order.sender === currentUser.name) {
                    showDuplicateBadge = true;
                }
            }
            
            const statusBadge = order.status === 'مكتمل' 
                ? '<span class="badge badge-success"><i class="fas fa-check-circle ml-1"></i> مكتمل</span>'
                : '<span class="badge badge-warning"><i class="fas fa-clock ml-1"></i> قيد المراجعة</span>';
            
            const duplicateBadge = showDuplicateBadge ? `
                <div class="duplicate-badge">
                    <i class="fas fa-exclamation-triangle"></i>
                    مكرر
                </div>
            ` : '';
            
            const categoryDisplay = order.category 
                ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold">فئة ${order.category}</span>`
                : '<span class="text-gray-400">-</span>';
            
            const joinDateDisplay = order.joinDate 
                ? order.joinDate 
                : '<span class="text-gray-400">-</span>';
            
            const notesDisplay = order.notes 
                ? `<div class="mt-2 p-3 bg-gray-50 rounded-lg">
                      <span class="text-xs text-gray-500 font-medium">ملاحظات المرسل:</span>
                      <p class="text-gray-700 text-sm mt-1">${order.notes}</p>
                   </div>`
                : '';
            
            // عرض الصورة إن وجدت
            let imageDisplay = '';
            if (order.imageData) {
                imageDisplay = `
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">
                                <i class="fas fa-image ml-1"></i> الصورة المرفقة:
                            </span>
                            <span class="text-xs text-gray-500">${order.imageName || ''}</span>
                        </div>
                        <img src="${order.imageData}" 
                             alt="صورة الطلب" 
                             class="order-image"
                             onclick="openImageModal('${order.imageData}')"
                             title="انقر لعرض الصورة بالحجم الكامل">
                    </div>
                `;
            }
            
            // توليد جدول زمني لحالات الطلب
            let statusTimelineHTML = '';
            if (order.statusTimeline) {
                statusTimelineHTML = generateStatusTimelineHTML(order.statusTimeline);
            } else {
                // إنشاء جدول زمني افتراضي للطلبات القديمة
                statusTimelineHTML = generateDefaultTimelineHTML(order);
            }
            
            // معلومات التكرار (تظهر فقط للمسؤول ومقدم الطلب)
            let duplicateInfo = '';
            if (showDuplicateBadge) {
                const duplicateMsg = order.isDuplicate 
                    ? '<p class="text-red-600 text-sm font-bold mt-2"><i class="fas fa-exclamation-triangle ml-1"></i> تم إرسال هذا الطلب مع تحذير التكرار</p>'
                    : '<p class="text-amber-600 text-sm font-bold mt-2"><i class="fas fa-clone ml-1"></i> هناك طلبات أخرى بنفس البيانات</p>';
                
                duplicateInfo = `
                    <div class="mt-3 p-3 border border-red-200 rounded-lg bg-red-50">
                        <p class="text-red-700 text-sm font-bold flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            تنبيه: بيانات مشابهة لطلبات سابقة
                        </p>
                        ${duplicateMsg}
                    </div>
                `;
            }
            
            // عرض ملاحظات المسؤول إن وجدت
            const adminNotesDisplay = order.adminNotes ? `
                <div class="mt-4 p-4 bg-purple-50 rounded-xl">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-purple-700">
                            <i class="fas fa-sticky-note ml-1"></i> ملاحظات المسؤول:
                        </span>
                    </div>
                    <div class="admin-notes-content">
                        ${order.adminNotes}
                    </div>
                </div>
            ` : '';
            
            let actionsHTML = '';
            if (currentUser.role === 'admin') {
                actionsHTML = `
                    <div class="flex gap-2 mt-4">
                        <button onclick="openReplyModal('${order.id}')" class="flex-1 btn btn-primary py-2 text-sm">
                            <i class="fas fa-reply ml-1"></i> رد المسؤول
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="btn btn-danger px-4">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else if (order.sender === currentUser.name && order.status === "قيد المراجعة") {
                actionsHTML = `
                    <div class="flex gap-2 mt-4">
                        <button onclick="deleteOrder('${order.id}')" class="flex-1 btn btn-danger py-2 text-sm">
                            <i class="fas fa-trash ml-1"></i> حذف الطلب
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="order-card ${statusClass} ${duplicateClass}" data-id="${order.id}">
                    ${duplicateBadge}
                    
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-lg">${order.subjectName}</h4>
                            <p class="text-gray-600 text-sm mt-1">
                                <i class="far fa-user ml-1"></i> ${order.sender}
                            </p>
                        </div>
                        <div class="flex flex-col items-end">
                            ${statusBadge}
                            <span class="text-xs text-gray-500 mt-2">${order.timestamp}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="order-info-row">
                            <span class="label">الجنس:</span>
                            <span class="value">${order.gender || '-'}</span>
                        </div>
                        <div class="order-info-row">
                            <span class="label">تاريخ الميلاد:</span>
                            <span class="value">${order.birth || '-'}</span>
                        </div>
                        <div class="order-info-row">
                            <span class="label">تاريخ الانتساب:</span>
                            <span class="value">${joinDateDisplay}</span>
                        </div>
                        <div class="order-info-row">
                            <span class="label">الفئة:</span>
                            <span class="value">${categoryDisplay}</span>
                        </div>
                    </div>
                    
                    ${imageDisplay}
                    ${notesDisplay}
                    ${statusTimelineHTML}
                    ${duplicateInfo}
                    
                    <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-blue-700">
                                <i class="fas fa-comment-dots ml-1"></i> رد المسؤول:
                            </span>
                            ${order.reply ? `
                                <button onclick="copyReply('${order.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700">
                                    <i class="far fa-copy ml-1"></i> نسخ
                                </button>
                            ` : ''}
                        </div>
                        <div class="reply-content">
                            ${order.reply || 'بانتظار رد المسؤول...'}
                        </div>
                    </div>
                    
                    ${adminNotesDisplay}
                    
                    ${actionsHTML}
                </div>
            `;
        }

        // دالة توليد HTML لجدول الحالات الزمني
        function generateStatusTimelineHTML(statusTimeline) {
            let html = '<div class="order-status-timeline">';
            
            // حالة قيد المراجعة
            if (statusTimeline.pending) {
                html += `
                    <div class="status-item">
                        <div class="status-dot pending"></div>
                        <div>
                            <div class="status-label">${statusTimeline.pending.status}</div>
                            <div class="status-time">${statusTimeline.pending.time}</div>
                        </div>
                    </div>
                    <div class="status-separator"></div>
                `;
            }
            
            // حالة مشاهدة المسؤول (إذا كانت موجودة)
            if (statusTimeline.viewed) {
                html += `
                    <div class="status-item">
                        <div class="status-dot viewed"></div>
                        <div>
                            <div class="status-label">${statusTimeline.viewed.status}</div>
                            <div class="status-time">${statusTimeline.viewed.time}</div>
                        </div>
                    </div>
                    <div class="status-separator"></div>
                `;
            }
            
            // حالة اكتمال الطلب (إذا كانت موجودة)
            if (statusTimeline.completed) {
                html += `
                    <div class="status-item">
                        <div class="status-dot completed"></div>
                        <div>
                            <div class="status-label">${statusTimeline.completed.status}</div>
                            <div class="status-time">${statusTimeline.completed.time}</div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // دالة توليد جدول زمني افتراضي للطلبات القديمة
        function generateDefaultTimelineHTML(order) {
            let html = '<div class="order-status-timeline">';
            
            // حالة قيد المراجعة (تاريخ الإرسال)
            html += `
                <div class="status-item">
                    <div class="status-dot pending"></div>
                    <div>
                        <div class="status-label">قيد المراجعة</div>
                        <div class="status-time">${order.timestamp}</div>
                    </div>
                </div>
                <div class="status-separator"></div>
            `;
            
            // حالة اكتمال الطلب (إذا كان الطلب مكتملاً)
            if (order.status === 'مكتمل') {
                const completionTime = order.replyTimestamp || order.timestamp;
                html += `
                    <div class="status-item">
                        <div class="status-dot completed"></div>
                        <div>
                            <div class="status-label">مكتمل</div>
                            <div class="status-time">${completionTime}</div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // دالة تحديث عداد الطلبات المكررة
        function updateDuplicateCounter() {
            // تحديث العداد بناءً على الطلبات المكررة
            let visibleDuplicateCount = 0;
            if (currentUser.role === 'admin') {
                // المسؤول يرى جميع الطلبات المكررة
                visibleDuplicateCount = duplicateCount;
            } else {
                // المستخدم يرى فقط طلباته المكررة
                visibleDuplicateCount = allOrders.filter(o => 
                    o.isDuplicate && o.sender === currentUser.name
                ).length;
            }
            
            if (visibleDuplicateCount > 0) {
                document.getElementById('duplicate-count').classList.remove('hidden');
                document.getElementById('duplicate-number').innerText = visibleDuplicateCount;
            } else {
                document.getElementById('duplicate-count').classList.add('hidden');
            }
        }

        // دالة إعداد البحث والتصفية مع تحسينات للأداء
        function setupSearchAndFilter() {
            const searchBox = document.getElementById('search-box');
            const filterStatus = document.getElementById('filter-status');
            
            // تحسين البحث مع تأخير debounce لتجنب التحميل الزائد
            searchBox.addEventListener('input', () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    displayOrders(allOrders);
                }, window.innerWidth < 768 ? 300 : 150); // وقت أطول على الهاتف
            });
            
            // تحسين الفلترة مع معالجة أفضل للأداء
            filterStatus.addEventListener('change', () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    displayOrders(allOrders);
                }, window.innerWidth < 768 ? 100 : 50); // وقت أقل للفلترة
            });
        }

        // دالة تحديث الإحصائيات
        function updateStats(stats) {
            if (currentUser.role === 'admin') {
                document.getElementById('stat-total').innerText = stats.total;
                document.getElementById('stat-pending').innerText = stats.pending;
                document.getElementById('stat-done').innerText = stats.done;
                document.getElementById('stat-duplicate').innerText = stats.duplicate;
            }
        }

        // دالة نسخ الرد
        window.copyReply = function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.reply) return;
            
            navigator.clipboard.writeText(order.reply)
                .then(() => {
                    showPushNotification('تم النسخ', 'تم نسخ الرد بنجاح', 'success');
                })
                .catch(() => alert("حدث خطأ في النسخ"));
        };

        // دالة فتح مودال رد المسؤول
        window.openReplyModal = function(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            selectedOrderId = orderId;
            
            document.getElementById('modal-title').innerText = 'رد على الطلب';
            
            let imageSection = '';
            if (order.imageData) {
                imageSection = `
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">الصورة المرفقة:</p>
                        <img src="${order.imageData}" 
                             alt="صورة الطلب" 
                             class="w-full max-w-xs mx-auto rounded-lg cursor-pointer"
                             onclick="openImageModal('${order.imageData}')"
                             title="انقر لعرض الصورة بالحجم الكامل">
                        ${order.imageName ? `<p class="text-xs text-gray-500 text-center mt-2">${order.imageName}</p>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">الطلب المقدم من:</p>
                        <p class="font-bold text-lg">${order.sender}</p>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div>
                                <p class="text-sm text-gray-600">صاحب الطلب:</p>
                                <p class="font-medium">${order.subjectName || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">تاريخ الميلاد:</p>
                                <p class="font-medium">${order.birth || '-'}</p>
                            </div>
                        </div>
                        ${imageSection}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-edit ml-1"></i> رد المسؤول *
                        </label>
                        <textarea 
                            id="admin-reply-text" 
                            rows="4" 
                            class="w-full p-3"
                            placeholder="اكتب الرد الرسمي هنا..."
                            required
                        >${order.reply || ''}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sticky-note ml-1"></i> ملاحظات المسؤول
                            <span class="text-gray-400 text-xs">(اختياري)</span>
                        </label>
                        <textarea 
                            id="admin-notes-text" 
                            rows="3" 
                            class="w-full p-3"
                            placeholder="ملاحظات إضافية خاصة..."
                        >${order.adminNotes || ''}</textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-reply').classList.remove('hidden');
            document.getElementById('admin-reply-text').focus();
        };

        // دالة حفظ رد المسؤول مع تحديث الجدول الزمني
        window.saveReply = function() {
            const reply = document.getElementById('admin-reply-text').value.trim();
            const adminNotes = document.getElementById('admin-notes-text').value.trim();
            
            if (!reply) {
                alert("يرجى كتابة الرد الرسمي أولاً");
                return;
            }
            
            const order = allOrders.find(o => o.id === selectedOrderId);
            const currentTime = new Date().toLocaleString('ar-EG');
            const currentTimestamp = Date.now();
            
            // تحديث بيانات الطلب مع الحفاظ على الجدول الزمني القديم
            const statusTimeline = order.statusTimeline || {};
            
            // تحديث حالة مشاهدة المسؤول (إذا لم تكن موجودة)
            if (!statusTimeline.viewed) {
                statusTimeline.viewed = {
                    status: "تمت المشاهدة من المسؤول",
                    time: currentTime,
                    timestamp: currentTimestamp
                };
            }
            
            // تحديث حالة اكتمال الطلب
            statusTimeline.completed = {
                status: "مكتمل",
                time: currentTime,
                timestamp: currentTimestamp
            };
            
            const updates = {
                reply: reply,
                status: "مكتمل",
                replyTimestamp: currentTime,
                statusTimeline: statusTimeline
            };
            
            // إضافة ملاحظات المسؤول إن وجدت
            if (adminNotes) {
                updates.adminNotes = adminNotes;
            }
            
            update(ref(db, 'orders/' + selectedOrderId), updates)
            .then(() => {
                // إرسال إشعار للمستخدم عن الرد
                sendNotification('order_replied', order.sender, 'المسؤول العام', order.subjectName);
                
                // إرسال إشعار اكتمال الطلب
                sendNotification('order_completed', order.sender, 'المسؤول العام', order.subjectName);
                
                showPushNotification('تم الرد على الطلب', `تم الرد على طلب ${order.subjectName}`, 'success');
                closeModal();
                fetchOrders();
            })
            .catch(error => {
                showPushNotification('خطأ في الحفظ', error.message, 'warning');
                alert("حدث خطأ: " + error.message);
            });
        };

        // دالة حذف الطلب
        window.deleteOrder = function(orderId) {
            if (!confirm("هل أنت متأكد من حذف هذا الطلب؟")) return;
            
            remove(ref(db, 'orders/' + orderId))
                .then(() => {
                    showPushNotification('تم الحذف', 'تم حذف الطلب بنجاح', 'success');
                    fetchOrders();
                })
                .catch(error => {
                    showPushNotification('خطأ في الحذف', error.message, 'warning');
                    alert("حدث خطأ: " + error.message);
                });
        };

        // دالة إغلاق المودال
        window.closeModal = function() {
            document.getElementById('modal-reply').classList.add('hidden');
            selectedOrderId = '';
        };

        // دالة تسجيل الخروج
        window.logout = function() {
            localStorage.clear();
            showPushNotification('تم تسجيل الخروج', 'تم تسجيل الخروج بنجاح', 'info');
            setTimeout(() => {
                location.reload();
            }, 1000);
        };

        // التحقق من الجلسة الحالية
        const session = localStorage.getItem('user_session');
        if (session) {
            const sessionData = JSON.parse(session);
            currentUser = { name: sessionData.name, role: sessionData.role };
            showDashboard();
        }

        // تقييد إدخال كلمة المرور لأرقام فقط
        document.getElementById('login-pass').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // إغلاق قائمة الإشعارات عند النقر خارجها
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notifications-dropdown');
            const notificationsBtn = document.querySelector('.notifications-btn');
            
            if (dropdown && !dropdown.classList.contains('hidden') && 
                !dropdown.contains(event.target) && 
                !notificationsBtn.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // إغلاق مودال الصورة عند النقر خارجها
        document.getElementById('image-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeImageModal();
            }
        });

        // إغلاق مودال الصورة بمفتاح ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && !document.getElementById('image-modal').classList.contains('hidden')) {
                closeImageModal();
            }
        });

        // دعم سحب وإفلات الصور
        const dropArea = document.getElementById('no-image-section');
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#3b82f6';
            dropArea.style.background = '#f0f9ff';
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#e2e8f0';
            dropArea.style.background = '#f8fafc';
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#e2e8f0';
            dropArea.style.background = '#f8fafc';
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.match('image.*')) {
                // محاكاة تغيير input file
                const input = document.getElementById('image-upload');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                
                // تشغيل دالة المعاينة
                previewImage({ target: input });
            } else {
                alert('يرجى اختيار ملف صورة فقط');
            }
        });

        // تسجيل Service Worker للإشعارات الدفعية
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/firebase-messaging-sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }

        // تهيئة الإشعارات الدفعية
        function initializePushNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                    }
                });
            }
        }

        // استدعاء تهيئة الإشعارات عند التحميل
        initializePushNotifications();
    </script>
</body>
</html>